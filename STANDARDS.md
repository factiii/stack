# Core Standards

This document defines the architecture, configuration patterns, and development standards for the Core infrastructure package.

## Philosophy

**Single Approach:** Base core with auto-scanning adapters.

- Scans T3 project structure automatically
- Detects stack components and pulls appropriate adapters
- Auto-configures based on detected setup
- No manual repo consolidation or centralized config management

The system scans your repository, identifies packages (Next.js, Expo, tRPC, Prisma), assigns adapters, and consolidates everything into configuration files.

---

## Configuration Standards

### Two Configuration Files

| File | Purpose | Editable By |
|------|---------|-------------|
| `core.yml` | Settings that **cannot** be auto-detected | User (manual) |
| `coreAuto.yml` | Settings that **are** auto-detected | Core (automatic) |

### core.yml (Manual Settings)

For settings the user MUST configure manually, use the pattern:

```yaml
# Description of what this setting does
setting_name: EXAMPLE-actual-value-format
```

**Rules:**
- All manual settings use `EXAMPLE-` prefix to indicate they need user input
- Each setting has a comment above explaining its purpose
- Core will block deployment if any `EXAMPLE-` values remain

**Example:**
```yaml
# Repository name - must match your GitHub repository
name: EXAMPLE-factiii

# SSL email for Let's Encrypt certificates
ssl_email: EXAMPLE-admin@yourdomain.com

# Staging domain for your application
staging_domain: EXAMPLE-staging.yourdomain.com
```

### coreAuto.yml (Auto-Detected Settings)

For settings that Core detects automatically. Generated by running `npx core init`.

**Override Pattern:**
```yaml
setting_name: detected_value OVERRIDE custom_value
```

**Example:**
```yaml
# Auto-detected, using default
prisma_schema: apps/server/prisma/schema.prisma

# Auto-detected, but user overrode
dockerfile: apps/server/Dockerfile OVERRIDE custom/Dockerfile
```

**Warning System:**
Core warns when:
- Auto-detected value != deployed value (unexpected drift)
- Auto-detected value != override value (intentional change acknowledged)
- Deployed value changed without corresponding override

---

## Environment Standards

### Environment Files

| File | Required | Git Status | Purpose |
|------|----------|------------|---------|
| `.env.dev` | Mandatory | Committed | Development defaults, safe values |
| `.env.staging` | Optional | Configurable | Staging environment values |
| `.env.prod` | Mandatory | **Gitignored** | Production secrets |
| `.env.test` | Optional | Committed | Test environment values |

### Adapter Environment Reporting

All adapters report any environment variables they require. Core consolidates these into `.env.dev` as a template with example values.

For secret keys (e.g., OpenAI API key), adapters can add OAuth flows or CLI commands to auto-pull necessary credentials.

---

## Commands

Core provides exactly **3 commands**:

### `npx core init`

**Purpose:** Comprehensive check of everything - local, GitHub, and remote servers. Auto-fixes local only.

**What It Checks:**
- **Local environment:** All files, configs, dependencies, scripts
- **GitHub:** Secrets, workflows, repository settings
- **Remote servers:** Deployed configurations (read-only via SSH)

**Local Dev Environment (Auto-Fix Enabled):**
- Run package detection (Next.js, Expo, tRPC, Prisma)
- Generate/update `coreAuto.yml`
- Validate `core.yml` (check for EXAMPLE- values)
- Auto-install missing dependencies
- Generate missing config files
- Create .env templates if missing
- Fix package.json scripts
- Update .gitignore if needed
- **Can delete/modify files** - developers understand git

**GitHub (Check-Only):**
- Verify required secrets exist (STAGING_ENVS, PROD_ENVS, SSH keys, etc.)
- Check workflow files are present
- Report missing or misconfigured secrets
- **NO modifications** - use `init fix` to upload secrets

**Remote Environments (Staging/Prod) - Check-Only:**
- SSH to servers (read-only)
- Validate deployed configurations
- Compare deployed vs local configs
- Report mismatches and drift
- **NO modifications allowed** - use `init fix` for server-side fixes

**Exit Codes:**
- Exit 0: Success (permissive, even with warnings)
- Exit non-zero: Critical local errors only

### `npx core init fix`

**Purpose:** Fix everything that `init` checks - local, GitHub, and remote servers. Guarantees deploy will work.

**Must be explicitly called** - never runs automatically.

**What It Fixes:**

**Local Environment:**
- Everything `init` does (auto-fix enabled)
- All local configs, dependencies, scripts, files

**GitHub:**
- Upload missing secrets from `.env.staging` → `STAGING_ENVS`
- Upload missing secrets from `.env.prod` → `PROD_ENVS`
- Create/update GitHub Secrets as needed
- Verify all required secrets are present

**Remote Servers (Staging/Prod):**
- SSH to servers and fix infrastructure:
  - Create missing directories
  - Fix file permissions
  - Install missing dependencies
  - Generate server-side configs
  - Validate configurations

**What It Does NOT Do:**
- Deploy containers (that's what `deploy` is for)
- Update server deployment configs (nginx, docker-compose on servers)
- Restart running services
- Modify application code

**After `init fix`:**
- Everything is fully prepared for deployment
- All local configs are correct
- All GitHub secrets are uploaded
- All server infrastructure is ready
- Run `npx core deploy` to actually deploy

**Safety:**
- Prompts for confirmation before remote changes
- Supports `--dry-run` to preview changes

**When to Use:**
- Initial setup of new environments
- After major configuration changes
- When `deploy` fails with blocking errors
- When GitHub secrets are missing
- To prepare everything for deployment

### `npx core deploy`

**Purpose:** Run init check, then deploy if checks pass.

**Pre-deployment Check:**
Runs `init` (NOT `init fix`) first. Analyzes failures:

**Non-Blocking Failures (proceed with warning):**
- Environment variable changes (intentional rekey)
- Domain updates
- Port reassignments
- Auto-detected changes with explicit overrides

**Blocking Failures (stop deployment):**
- Missing required settings (EXAMPLE- values present)
- Invalid YAML syntax
- Missing critical files (Dockerfile, package.json)
- SSH connection failures
- Invalid domain formats
- Conflicting configurations
- Auto-detected changes WITHOUT overrides (unexpected drift)

**On Blocking Failure:**
```
❌ Deployment blocked: Missing required setting
   Setting: ssl_email
   Current: EXAMPLE-admin@yourdomain.com
   
   Fix: Update core.yml with actual value
   Then: npx core init fix
```

---

## GitHub Actions Workflows

### Staging (main branch)

**Trigger:** PR merged to main

**Flow:**
1. Run init checks
2. Build application
3. Run tests
4. Deploy container to staging server

### Production (production branch)

**Trigger:** Merge to production branch

**Flow:**
1. Clean repository
2. `pnpm install` (fresh)
3. Run tests
4. Build application
5. Deliver container (push to registry)
6. Deploy container to production server
7. Run database migrations

---

## Current Stack

Core currently supports the T3 + Expo stack:

| Component | Purpose |
|-----------|---------|
| Next.js | Web application |
| Expo | Mobile application |
| tRPC | Type-safe API layer |
| Prisma | Database ORM |

---

## Future: Adapter Roadmap

Adapters will be extracted from core one by one:

| Phase | Adapter | Status |
|-------|---------|--------|
| 1 | Core only | **Current** |
| 2 | Next.js | Planned |
| 3 | Expo | Planned |
| 4 | Prisma/tRPC | Planned |

### Adapter Types (Future)

**Stack Adapters** - Detect and configure stack components:
- Next.js adapter
- Expo adapter
- tRPC adapter
- Prisma adapter

**CLI Adapters** - Shared utilities for other adapters:
- AWS adapter (ECR, S3, CLI auth)
- GitHub adapter (API, Actions, Secrets)
- Azure adapter

**Infrastructure Adapters** - Deployment and hosting:
- Docker adapter
- nginx adapter
- CICD adapter

---

## Deployment Targets

| Environment | Platform | Details |
|-------------|----------|---------|
| Staging | Any Mac | Development/testing server |
| Production | Any Ubuntu | Production hosting |

**Container Stack:**
- nginx (reverse proxy)
- Docker containers (application)

**Multi-Server Support:**
- `PROD_SSH` - Primary production server
- `PROD_SSH2` - Replica server (optional)
- Additional replicas as needed

---

## Development in This Repository

**Important:** This repository IS the Core package itself.

**DO NOT** run `npx core` commands inside this repository. These commands should only be run in APPLICATION repositories that consume this package.

### Testing Changes

1. Make changes to source files in `src/`
2. Test in a SEPARATE application repository:
   ```bash
   cd /path/to/test-app
   npm link /path/to/infrastructure
   npx core init
   ```

### Key Directories

```
/infrastructure/
├── bin/core              # CLI entry point
├── src/
│   ├── cli/              # Command implementations
│   ├── generators/       # Config generators
│   ├── utils/            # Utilities
│   └── workflows/        # GitHub Actions templates
├── scripts/              # Bash scripts for servers
├── templates/            # Config templates
└── test/                 # Test suites
```

