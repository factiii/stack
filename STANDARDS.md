# Core Standards

This document defines the architecture, configuration patterns, and development standards for the Core infrastructure package.

## Philosophy

**Single Approach:** Base core with auto-scanning adapters.

- Scans T3 project structure automatically
- Detects stack components and pulls appropriate adapters
- Auto-configures based on detected setup
- No manual repo consolidation or centralized config management

The system scans your repository, identifies packages (Next.js, Expo, tRPC, Prisma), assigns adapters, and consolidates everything into configuration files.

---

## Configuration Standards

### Two Configuration Files

| File | Purpose | Editable By |
|------|---------|-------------|
| `core.yml` | Settings that **cannot** be auto-detected | User (manual) |
| `coreAuto.yml` | Settings that **are** auto-detected | Core (automatic) |

### core.yml (Manual Settings)

For settings the user MUST configure manually, use the pattern:

```yaml
# Description of what this setting does
setting_name: EXAMPLE-actual-value-format
```

**Rules:**
- All manual settings use `EXAMPLE-` prefix to indicate they need user input
- Each setting has a comment above explaining its purpose
- Core will block deployment if any `EXAMPLE-` values remain

**Example:**
```yaml
# Repository name - must match your GitHub repository
name: EXAMPLE-factiii

# SSL email for Let's Encrypt certificates
ssl_email: EXAMPLE-admin@yourdomain.com

# Staging domain for your application
staging_domain: EXAMPLE-staging.yourdomain.com
```

### coreAuto.yml (Auto-Detected Settings)

For settings that Core detects automatically. Generated by running `npx core init`.

**Override Pattern:**
```yaml
setting_name: detected_value OVERRIDE custom_value
```

**Example:**
```yaml
# Auto-detected, using default
prisma_schema: apps/server/prisma/schema.prisma

# Auto-detected, but user overrode
dockerfile: apps/server/Dockerfile OVERRIDE custom/Dockerfile
```

**Warning System:**
Core warns when:
- Auto-detected value != deployed value (unexpected drift)
- Auto-detected value != override value (intentional change acknowledged)
- Deployed value changed without corresponding override

---

## Environment Standards

### Environment Files

| File | Required | Git Status | Purpose |
|------|----------|------------|---------|
| `.env.dev` | Mandatory | Committed | Development defaults, safe values |
| `.env.staging` | Optional | Configurable | Staging environment values |
| `.env.prod` | Mandatory | **Gitignored** | Production secrets |
| `.env.test` | Optional | Committed | Test environment values |

### Adapter Environment Reporting

All adapters report any environment variables they require. Core consolidates these into `.env.dev` as a template with example values.

For secret keys (e.g., OpenAI API key), adapters can add OAuth flows or CLI commands to auto-pull necessary credentials.

---

## Commands

Core provides exactly **3 commands** following a **2-stage process**:

1. **Check** (`init`) - Discover ALL issues
2. **Fix** (`init fix`) - Fix ALL issues in logical order
3. **Deploy** (`deploy`) - Deploy containers

## The 2-Stage Process

**Why 2 stages?** 

Single-stage approaches fail because:
- Fix A fails because B isn't fixed
- Fix B breaks A
- Developer confused about state

**2-stage solution:**
1. Check everything first (discover ALL issues)
2. Fix in dependency order (each fix enables the next)

See [WORKFLOW.md](WORKFLOW.md) for detailed explanation.

---

### `npx core init`

**Stage 1: Check Everything**

**Purpose:** Comprehensive check of everything - local, GitHub, and remote servers. Auto-fixes local only.

**What It Checks:**
- **Local environment:** All files, configs, dependencies, scripts
- **GitHub:** Secrets, workflows, repository settings
- **Remote servers:** Deployed configurations (read-only via SSH)

**Local Dev Environment (Auto-Fix Enabled):**
- Run package detection (Next.js, Expo, tRPC, Prisma)
- Generate/update `coreAuto.yml`
- Validate `core.yml` (check for EXAMPLE- values)
- Auto-install missing dependencies
- Generate missing config files
- Create .env templates if missing
- Fix package.json scripts
- Update .gitignore if needed
- **Can delete/modify files** - developers understand git

**GitHub (Check-Only):**
- Verify required secrets exist (STAGING_ENVS, PROD_ENVS, SSH keys, etc.)
- Check workflow files are present
- Report missing or misconfigured secrets
- **NO modifications** - use `init fix` to upload secrets

**Remote Environments (Staging/Prod) - Check-Only:**
- SSH to servers (read-only)
- Validate deployed configurations
- Compare deployed vs local configs
- Report mismatches and drift
- **NO modifications allowed** - use `init fix` for server-side fixes

**Exit Codes:**
- Exit 0: Success (permissive, even with warnings)
- Exit non-zero: Critical local errors only

### `npx core init fix`

**Stage 2: Fix Everything in Logical Order**

**Purpose:** Fix everything that `init` checks - local, GitHub, and remote servers. Guarantees deploy will work.

**Must be explicitly called** - never runs automatically.

**Fix Order (Dependency Chain):**

```
1. Local Environment (files, configs)
   ↓ (must be correct before uploading)
2. GitHub Secrets (STAGING_ENVS, PROD_ENVS)
   ↓ (must exist before workflows/deployments)
3. Remote Servers (infrastructure setup)
   ↓ (must be set up before deployment)
4. Verification (workflow confirms fixes)
```

**Why this order?**
- Local configs must be correct before uploading to GitHub
- Secrets must exist in GitHub before servers can deploy
- Servers need secrets to set up environment
- Verification confirms everything worked

**What It Fixes:**

**Part 1 - Local Environment:**
- Generate missing config files
- Install missing dependencies
- Fix package.json scripts
- Update .gitignore
- Create .env templates

**Part 2 - GitHub Secrets:**
- Upload `STAGING_ENVS` from `.env.staging`
- Upload `PROD_ENVS` from `.env.prod`
- Verify all required secrets exist
- Display verification link

**Part 3 - Remote Servers:**
- SSH to servers (uses secrets from Part 2)
- Create infrastructure directories
- Fix file permissions
- Generate server configs
- Validate configurations

**Part 4 - Verification:**
- Trigger `core-init.yml` workflow with `fix=true`
- Run all checks again
- Confirm everything is working

**What It Does NOT Do:**
- Deploy containers (that's what `deploy` is for)
- Update server deployment configs (nginx, docker-compose on servers)
- Restart running services
- Modify application code

**Output:**
Provides comprehensive report showing what was fixed in each stage:
```
Stage 1: Discovering Issues
   [runs init check, shows all problems]

Stage 2: Fixing Issues
   Part 1: Local Environment ✅
   Part 2: GitHub Secrets ✅
   Part 3: Remote Servers ✅
   Part 4: Verification ✅

Summary of Fixes:
   ✅ Local: configs generated
   ✅ GitHub: STAGING_ENVS (36 vars)
   ✅ GitHub: PROD_ENVS (36 vars)
   ✅ Servers: staging ready
   ✅ Servers: prod ready
```

**After `init fix`:**
- Everything is fully prepared for deployment
- All dependencies resolved in order
- No "chicken and egg" problems
- Run `npx core deploy` to actually deploy

**Safety:**
- Prompts for confirmation before remote changes
- Supports `--dry-run` to preview changes
- Comprehensive report of all changes made

**When to Use:**
- Initial setup of new environments
- After major configuration changes
- When `deploy` fails with blocking errors
- When GitHub secrets are missing
- To prepare everything for deployment

**Key Principle:**
Never try to fix issues out of order. Always let `init fix` handle the dependency chain automatically.

### `npx core deploy`

**Purpose:** Run init check, then deploy if checks pass.

**Pre-deployment Check:**
Runs `init` (NOT `init fix`) first. Analyzes failures:

**Non-Blocking Failures (proceed with warning):**
- Environment variable changes (intentional rekey)
- Domain updates
- Port reassignments
- Auto-detected changes with explicit overrides

**Blocking Failures (stop deployment):**
- Missing required settings (EXAMPLE- values present)
- Invalid YAML syntax
- Missing critical files (Dockerfile, package.json)
- SSH connection failures
- Invalid domain formats
- Conflicting configurations
- Auto-detected changes WITHOUT overrides (unexpected drift)

**On Blocking Failure:**
```
❌ Deployment blocked: Missing required setting
   Setting: ssl_email
   Current: EXAMPLE-admin@yourdomain.com
   
   Fix: Update core.yml with actual value
   Then: npx core init fix
```

---

## GitHub Actions Workflows

### Key Distinction: Generated vs Used

**Core GENERATES workflows for repos but does NOT use them itself.**

| Aspect | Core CLI | Generated Workflows |
|--------|----------|---------------------|
| **Purpose** | Direct deployment | Repo CI/CD automation |
| **Triggered by** | `npx core deploy` | Git events (push, PR merge) |
| **Runs where** | Your machine | GitHub Actions |
| **Core involvement** | Core runs it | Core is NOT involved |

**Why both?**
- **CLI**: For manual/immediate deployments from your machine
- **Workflows**: For automated CI/CD on git events (optional but recommended)

### Generated Workflows

Core generates these workflows via `npx core generate-workflows`:

| Workflow | Trigger | Purpose |
|----------|---------|---------|
| `core-staging.yml` | PR/push to main | Auto-deploy to staging |
| `core-production.yml` | Merge to production | Auto-deploy to production |
| `core-undeploy.yml` | Manual trigger | Cleanup/remove deployment |

### Staging Workflow (main branch)

**Trigger:** PR merged to main

**Flow:**
1. Run tests
2. Build Docker image
3. Push to ECR
4. Deploy container to staging server

### Production Workflow (production branch)

**Trigger:** Merge to production branch

**Flow:**
1. Run tests
2. Build Docker image
3. Push to ECR
4. Backup database
5. Deploy container to production server
6. Run database migrations
7. Health check (rollback on failure)

---

## Current Stack

Core currently supports the T3 + Expo stack:

| Component | Purpose |
|-----------|---------|
| Next.js | Web application |
| Expo | Mobile application |
| tRPC | Type-safe API layer |
| Prisma | Database ORM |

---

## Future: Adapter Roadmap

Adapters will be extracted from core one by one:

| Phase | Adapter | Status |
|-------|---------|--------|
| 1 | Core only | **Current** |
| 2 | Next.js | Planned |
| 3 | Expo | Planned |
| 4 | Prisma/tRPC | Planned |

### Adapter Types (Future)

**Stack Adapters** - Detect and configure stack components:
- Next.js adapter
- Expo adapter
- tRPC adapter
- Prisma adapter

**CLI Adapters** - Shared utilities for other adapters:
- AWS adapter (ECR, S3, CLI auth)
- GitHub adapter (API, Actions, Secrets)
- Azure adapter

**Infrastructure Adapters** - Deployment and hosting:
- Docker adapter
- nginx adapter
- CICD adapter

---

## Deployment Targets

| Environment | Platform | Details |
|-------------|----------|---------|
| Staging | Any Mac | Development/testing server |
| Production | Any Ubuntu | Production hosting |

**Container Stack:**
- nginx (reverse proxy)
- Docker containers (application)

**Multi-Server Support:**
- `PROD_SSH` - Primary production server
- `PROD_SSH2` - Replica server (optional)
- Additional replicas as needed

---

## Development in This Repository

**Important:** This repository IS the Core package itself.

**DO NOT** run `npx core` commands inside this repository. These commands should only be run in APPLICATION repositories that consume this package.

### Testing Changes

1. Make changes to source files in `src/`
2. Test in a SEPARATE application repository:
   ```bash
   cd /path/to/test-app
   npm link /path/to/infrastructure
   npx core init
   ```

### Key Directories

```
/infrastructure/
├── bin/core              # CLI entry point
├── src/
│   ├── cli/              # Command implementations
│   │   ├── init.js       # Validate + auto-fix local
│   │   ├── init-fix.js   # Fix all environments
│   │   ├── deploy.js     # Direct SSH deployment
│   │   ├── deployer.js   # SSH deployment engine
│   │   └── generate-workflows.js  # Generate repo CI/CD workflows
│   ├── generators/       # Config generators
│   ├── utils/            # Utilities
│   └── workflows/        # Workflow templates (generated FOR repos, not used BY Core)
│       ├── core-staging.yml     # Repo CI/CD: auto-deploy on PR/push to main
│       ├── core-production.yml  # Repo CI/CD: auto-deploy on merge to production
│       └── core-undeploy.yml    # Manual cleanup trigger
├── scripts/              # Bash scripts for servers
├── templates/            # Config templates
└── test/                 # Test suites
```

