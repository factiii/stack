# Repository Setup Guide

Each repository manages its own infrastructure configuration. This guide shows how to set up a new repository to work with the infrastructure package.

> **Decentralized Architecture**
> Each repo stores its own `infrastructure.yml` config and deploys directly to servers.
> No central infrastructure repo is needed. See **[QUICK_START.md](QUICK_START.md)** for the complete guide.

## Quick Setup

1. **Install the package** (or use npx):
   ```bash
   npm install @yourorg/infrastructure
   # OR just use npx (no install needed)
   ```

2. **Initialize config**:
   ```bash
   npx infra init
   ```

3. **Edit `infrastructure.yml`** with your domains and settings

4. **Validate config**:
   ```bash
   npx infra validate
   ```

5. **Generate GitHub workflows**:
   ```bash
   npx infra generate-workflows
   ```

6. **Add GitHub secrets** (see below)

7. **Deploy**:
   ```bash
   npx infra deploy --environment staging
   ```

## Required Files

```
your-repo/
├── infrastructure.yml          # Required: Infrastructure config (created by `infra init`)
├── Dockerfile                   # Required: Docker build file (or apps/server/Dockerfile)
├── .env.example                 # Recommended: Template for environment variables
└── .github/
    └── workflows/
        ├── check-config.yml     # Generated by `infra generate-workflows`
        ├── deploy-staging.yml   # Generated by `infra generate-workflows`
        └── deploy-prod.yml      # Generated by `infra generate-workflows`
```

## Dockerfile Requirements

- **Location**: `Dockerfile` at root, or `apps/server/Dockerfile` (specify in `infrastructure.yml` with `dockerfile` field)
- **Health endpoint**: Must expose a `/health` endpoint (or customize with `health_check` in config)
- **Port**: Should listen on the port specified in your config (auto-assigned if not specified)

**Example Dockerfile:**
```dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --production
COPY . .
EXPOSE 3001
CMD ["node", "server.js"]
```

## Infrastructure Configuration

After running `npx infra init`, edit `infrastructure.yml`:

```yaml
# Repository name (must match GitHub repo name)
name: your-repo-name

# Environment configurations
environments:
  staging:
    domain: staging-your-repo.yourdomain.com
    port: 3001  # Optional - auto-assigned if not specified
    health_check: /health
    env_file: .env.staging  # Optional - secrets stored securely on server

  prod:
    domain: your-repo.yourdomain.com
    port: 3002  # Optional
    health_check: /health
    env_file: .env.prod  # Optional

# Global settings
ssl_email: admin@yourdomain.com
ecr_registry: 123456789.dkr.ecr.us-east-1.amazonaws.com
ecr_repository: apps

# Dockerfile path (optional, defaults to Dockerfile)
# dockerfile: Dockerfile
# dockerfile: apps/server/Dockerfile  # For monorepos
```

**Key points:**
- Ports are auto-assigned starting at 3001 if not specified
- Domain conflicts are detected automatically
- `env_file` is optional - if specified, secrets are stored securely on server

## GitHub Secrets Setup

In your repository's **Settings → Secrets and variables → Actions**, add:

### Required Secrets

**SSH Keys:**
- `STAGING_SSH` - SSH private key for staging server
- `PROD_SSH` - SSH private key for production server

**Server Connection:**
- `STAGING_HOST` - Staging server hostname/IP
- `STAGING_USER` - SSH user for staging (default: ubuntu)
- `PROD_HOST` - Production server hostname/IP
- `PROD_USER` - SSH user for production (default: ubuntu)

**AWS Credentials (for ECR):**
- `AWS_ACCESS_KEY_ID` - AWS access key ID
- `AWS_SECRET_ACCESS_KEY` - AWS secret access key
- `AWS_REGION` - AWS region (e.g., us-east-1)

### Optional Secrets (Environment Variables)

If your config specifies `env_file`, add these secrets:

- `STAGING_ENVS` - Environment variables for staging (newline-separated `key=value` pairs)
- `PROD_ENVS` - Environment variables for production (newline-separated `key=value` pairs)

**Format for ENVS:**
```
NODE_ENV=staging
PORT=3001
DATABASE_URL=postgresql://postgres:postgres@postgres-staging:5432/mydb
CLIENT_APP_URL=https://staging-your-repo.yourdomain.com
```

**Note:** Production secrets MUST be stored as secrets (not variables) since they contain sensitive data.

## Naming Conventions

When your config is deployed to servers, these naming conventions are used:

**Config file on server:**
- `~/infrastructure/configs/<repo-name>.yml`

**Environment file on server (if env_file specified):**
- `~/infrastructure/<repo-name>-staging.env`
- `~/infrastructure/<repo-name>-prod.env`

**Docker Compose services:**
- `<repo-name>-staging`
- `<repo-name>-prod`

**Container names:**
- `<repo-name>-staging`
- `<repo-name>-prod`

**Nginx server blocks:**
- Uses the `domain` specified in your config

## Deployment Workflow

### Using CLI Commands

**Deploy to staging:**
```bash
npx infra deploy --environment staging
```

**Deploy to all environments:**
```bash
npx infra deploy --environment all
```

**Check configuration on servers:**
```bash
npx infra check-config --environment all
```

**Remove from servers:**
```bash
npx infra remove --environment staging
```

### Using GitHub Actions

After running `npx infra generate-workflows`, workflows are created:

1. **Push to `main` branch** → Triggers `deploy-staging.yml`
2. **Push to `production` branch** → Triggers `deploy-prod.yml`
3. **Manual trigger** → Run `check-config.yml` to verify all configs

The workflows will:
1. Build and push Docker image to ECR
2. SSH to target server(s)
3. Copy `infrastructure.yml` to `~/infrastructure/configs/<repo-name>.yml`
4. Write env file if `STAGING_ENVS` or `PROD_ENVS` secrets exist
5. Run `check-config.sh` to regenerate docker-compose.yml and nginx.conf
6. Pull latest image and restart service

## Adding a New Repository

### Step-by-Step

1. **In your repo**, run:
   ```bash
   npx infra init
   ```

2. **Edit `infrastructure.yml`** with your domains and settings

3. **Validate**:
   ```bash
   npx infra validate
   ```

4. **Generate workflows**:
   ```bash
   npx infra generate-workflows
   ```

5. **Add GitHub secrets** (see GitHub Secrets Setup above)

6. **Deploy**:
   ```bash
   npx infra deploy --environment staging
   ```

7. **Verify**:
   ```bash
   npx infra check-config --environment staging
   ```

The service will automatically appear in the server's docker-compose.yml and nginx.conf when configs are regenerated.

## Removing a Repository

### Using CLI

```bash
npx infra remove --environment staging
npx infra remove --environment all
```

This will:
1. Stop and remove service containers
2. Remove config file from server
3. Remove env file if it exists
4. Regenerate docker-compose.yml and nginx.conf without your repo
5. Verify all remaining repos are still properly configured

### Manual Removal

1. SSH to server
2. Remove config: `rm ~/infrastructure/configs/<repo-name>.yml`
3. Remove env file: `rm ~/infrastructure/<repo-name>-<env>.env`
4. Run `check-config.sh` to regenerate configs

## Port Assignment

- Ports auto-assign starting at 3001
- If you specify a port in your config, it's used (if available)
- Conflicts are detected and automatically resolved
- Port assignments are stored in generated docker-compose.yml

**Example:**
- Repo A (no port specified) → Gets 3001
- Repo B (port: 5001) → Gets 5001
- Repo C (no port specified) → Gets 3002 (3001 taken)
- Repo D (port: 3001) → Gets 3003 (3001 conflict, auto-resolved)

## Environment Variables

Environment variables are stored securely on servers in root-level files:
- `~/infrastructure/<repo-name>-staging.env`
- `~/infrastructure/<repo-name>-prod.env`

These files are:
- Created from GitHub secrets (`STAGING_ENVS`, `PROD_ENVS`)
- Set with secure permissions (600)
- Referenced in docker-compose.yml via `env_file`

**To update env vars:**
1. Update GitHub secret (`STAGING_ENVS` or `PROD_ENVS`)
2. Redeploy: `npx infra deploy --environment staging`

## Summary Checklist

### In Your Application Repo:

- [ ] Run `npx infra init` to create `infrastructure.yml`
- [ ] Edit `infrastructure.yml` with your domains and settings
- [ ] Run `npx infra validate` to check config
- [ ] Run `npx infra generate-workflows` to create GitHub workflows
- [ ] Add GitHub secrets:
  - [ ] `STAGING_SSH`, `PROD_SSH`
  - [ ] `STAGING_HOST`, `STAGING_USER`, `PROD_HOST`, `PROD_USER`
  - [ ] `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, `AWS_REGION`
  - [ ] `STAGING_ENVS`, `PROD_ENVS` (if using env_file)
- [ ] Deploy: `npx infra deploy --environment staging`
- [ ] Verify: `npx infra check-config --environment staging`

### On Servers:

- [ ] Infrastructure directory exists: `~/infrastructure/`
- [ ] Configs directory exists: `~/infrastructure/configs/`
- [ ] Config file deployed: `~/infrastructure/configs/<repo-name>.yml`
- [ ] Env file exists (if specified): `~/infrastructure/<repo-name>-<env>.env`
- [ ] Service running: `docker compose ps <repo-name>-<env>`

## Troubleshooting

### "Config validation failed"
- Run `npx infra validate` to see specific errors
- Check required fields are present in `infrastructure.yml`
- Verify YAML syntax is correct

### "SSH connection failed"
- Verify SSH key is in GitHub Secrets (`STAGING_SSH` or `PROD_SSH`)
- Test SSH manually: `ssh -i ~/.ssh/key user@host`
- Check hostname/IP is correct
- Ensure firewall allows SSH (port 22)

### "Port conflict"
- Ports are auto-assigned, but you can specify a port in your config
- Run `npx infra check-config` to see current port assignments
- Conflicts are automatically resolved

### "Service not starting"
- Check logs: `docker compose logs <service-name>` (on server)
- Verify config exists: `ls ~/infrastructure/configs/<repo-name>.yml` (on server)
- Run `npx infra check-config` to regenerate configs
- Check env file exists if specified: `ls ~/infrastructure/<repo-name>-<env>.env` (on server)

### "GitHub secrets missing"
- Run `npx infra check-config` to see which secrets are missing
- Add missing secrets in GitHub Settings → Secrets
- Ensure secret names match expected format

## Next Steps

- See **[QUICK_START.md](QUICK_START.md)** for complete quick start guide
- See **[README.md](README.md)** for full documentation
- See **[INITIAL_SETUP.md](INITIAL_SETUP.md)** for server setup details
