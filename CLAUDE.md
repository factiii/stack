# @factiii/stack CLI - AI Rules

## Hard Rules
- NEVER edit files outside `/Users/jon/infrastructure/`
- NEVER run `npx stack` in this repo (test in app repos via `pnpm link`)
- NEVER `git add/commit/push` without user approval
- NEVER delete/modify existing code comments without asking
- ALWAYS check STANDARDS.md before modifying plugin/workflow/architecture code
- WARN on standards violations before proceeding

## Standards (from STANDARDS.md)
1. **Thin workflows** - Only: trigger + secrets + SSH + CLI. No setup/clone/install/build/bash>5 lines. Exception: Node.js bootstrap.
2. **Local-only scan/fix** - NO SSH in fix functions. NO `GITHUB_ACTIONS` checks in fix functions. Pipeline routes via `canReach()`.
3. **Plugin structure** - 1000+ line plugins split into index.ts, scanfix/, environment files.
4. **Fix format** - {id, stage, severity, description, scan fn, fix fn|null, manualFix string}.
5. **Config values** - Required: `EXAMPLE-` prefix. Auto-detected: `OVERRIDE` pattern.
6. **Generated files** - Include `# Generated by @factiii/stack vX.X.X`.
7. **Dumb commands** - scan.ts/fix.ts/deploy.ts know nothing about GITHUB_TOKEN/SSH/workflows.
8. **Server plugins** - Define OS commands, NOT deployment targets.

## Tech Stack
Node.js + TypeScript, pnpm, Commander.js, YAML config (stack.yml/stackAuto.yml; legacy factiii.yml supported), Docker, GitHub Actions, AWS ECR

## Architecture

**Plugin categories:** SECRETS (github, aws-sm, vault) | SERVERS (mac-mini, ubuntu-server, aws-free-tier) | FRAMEWORKS (expo, nextjs, prisma-trpc-server) | ADDONS (auth, payments, storage) | PIPELINES (github-actions, gitlab-ci)

**Stages:** `--dev`, `--secrets`, `--staging`, `--prod` → pipeline returns `via:'local'`, `via:'workflow'`, or `reachable:false`

**Config:** stack.yml (user-edited), stackAuto.yml (auto-detected, user can OVERRIDE)

**Commands:** `npx stack` (scan+autofix local) | `npx stack fix` (fix all envs) | `npx stack deploy` (scan then deploy)

## Structure
```
src/
├── cli/           # scan.js, fix.js, deploy.js
├── generators/    # generate-compose.js, generate-nginx.js, generate-factiii-auto.js
├── plugins/
│   ├── interfaces/  # Base classes
│   ├── servers/
│   ├── secrets/
│   └── approved.json
├── utils/
└── workflows/     # GitHub Actions templates
```
Entry: `bin/factiii` | Docs: STANDARDS.md, README.md

## Code Patterns
- **File generation:** Check exists → compare content → skip if unchanged → write
- **YAML templates:** Use string concat (`'Value: ' + var`), NOT template literals (breaks YAML)
- **Critical code:** Add `// CRITICAL:` block with Why + Breaks-if-changed

## Workflow Pattern
```yaml
ssh -i ~/.ssh/deploy_key "$USER@$HOST" \
  "GITHUB_ACTIONS=true npx stack deploy --staging"
```

## Task Routing
| Request | Action |
|---------|--------|
| Test a change | Link to app repo, test there |
| Edit app files | Explain changes, don't edit directly |
| Commit | Ask confirmation first |
| New plugin | Extend base class from `src/plugins/interfaces/` |
| Debug workflow | Check `GITHUB_ACTIONS=true` + stage flag |
