# Factiii Stack Infrastructure - AI Development Rules

## Project Identity
This repository IS the `@factiii/stack` CLI tool. It is NOT an application that uses the tool.

## Hard Rules (Never Violate)

### Boundaries
- NEVER edit files outside `/Users/jon/infrastructure/`
- NEVER run `npx factiii` commands in this repository (test in app repos)
- NEVER run `git add`, `git commit`, `git push` without explicit user approval
- NEVER delete or modify existing code comments without asking

### When Testing Changes
1. Edit source files in `src/`
2. Test in a SEPARATE app repository: `cd /path/to/app && pnpm link /Users/jon/infrastructure && npx factiii`

## Standards Enforcement

**CRITICAL: Always check STANDARDS.md before writing or modifying any plugin, workflow, or architecture code.**

Before making changes, verify compliance with these standards. WARN the user immediately if any proposed or existing code violates:

1. **Workflow thinness** - Workflows MUST be ultra-thin (trigger + pass secrets + SSH + run CLI). No server setup, no repo cloning, no dependency installs, no build logic, no bash scripts >5 lines. Exception: Node.js bootstrap only.
2. **Stage execution pattern** - Scan/fix functions run LOCALLY only. NO SSH calls in fix functions. NO checking `GITHUB_ACTIONS` env var in fix functions. Pipeline handles routing via `canReach()`.
3. **Plugin structure** - Plugins with 1000+ lines must follow the file organization standard (index.ts, scanfix/, environment files).
4. **Fix array format** - Every fix needs: id, stage, severity, description, scan function, fix function (or null), manualFix string.
5. **Config patterns** - Required values use `EXAMPLE-` prefix. Auto-detected values use `OVERRIDE` pattern.
6. **Generated file versioning** - All generated files must include `# Generated by @factiii/stack vX.X.X`.
7. **Commands are DUMB** - `scan.ts`, `fix.ts`, `deploy.ts` must NOT know about GITHUB_TOKEN, SSH, or workflows. They only ask the pipeline plugin `canReach(stage)`.
8. **OS-based server plugins** - Server plugins define OS-specific commands, NOT deployment targets. Pipelines handle deployment orchestration.

If you detect a standards violation while reading or writing code, **stop and warn the user** before proceeding.

## Tech Stack
- Runtime: Node.js with TypeScript
- Package manager: pnpm
- CLI framework: Commander.js
- Config format: YAML (stack.yml, stackAuto.yml; legacy factiii.yml/factiiiAuto.yml supported)
- Deployment: Docker, GitHub Actions, AWS ECR

## Architecture

### Plugin Categories
| Category | Purpose | Examples |
|----------|---------|----------|
| SECRETS | Credential storage | github, aws-sm, vault |
| SERVERS | Runtime environments | mac-mini, ubuntu-server, aws-free-tier |
| FRAMEWORKS | Deployable apps | expo, nextjs, prisma-trpc-server |
| ADDONS | Framework extensions | auth, payments, storage |
| PIPELINES | CI/CD systems | github-actions, gitlab-ci |

### Stage Execution Pattern
Commands use stages: `--dev`, `--secrets`, `--staging`, `--prod`

For each stage, pipeline decides execution:
- `via: 'local'` - run locally
- `via: 'workflow'` - trigger GitHub workflow
- `reachable: false` - show error, stop

**Scan/fix functions run LOCALLY only:**
- NO SSH calls in fix functions
- Use `execSync` for local commands
- CLI/Pipeline handles remote execution context

### Configuration Files
| File | Purpose | Editable By |
|------|---------|-------------|
| `stack.yml` | Manual settings | User |
| `stackAuto.yml` | Auto-detected settings | Factiii (user can OVERRIDE) |

**Required values:** Prefix with `EXAMPLE-` (blocks deployment until replaced)
**Override pattern:** `detected_value OVERRIDE custom_value`

## CLI Commands

| Command | Behavior |
|---------|----------|
| `npx factiii` | Scan + auto-fix local, check-only remote |
| `npx factiii fix` | Fix ALL environments including remote |
| `npx factiii deploy` | Run scan, deploy if checks pass |

## Project Structure
```
src/
├── cli/                    # Command implementations
│   ├── scan.js            # Default command
│   ├── fix.js             # Fix all environments
│   └── deploy.js          # Deploy to servers
├── generators/            # Config generators
│   ├── generate-compose.js
│   ├── generate-nginx.js
│   └── generate-factiii-auto.js
├── plugins/
│   ├── interfaces/        # Base classes (server-provider.js, secret-store.js, etc.)
│   ├── servers/           # Server plugins
│   ├── secrets/           # Secret store plugins
│   └── approved.json      # Approved external plugins
├── utils/                 # Shared utilities
└── workflows/             # GitHub Actions templates
```

Key files:
- `bin/factiii` - CLI entry point
- `STANDARDS.md` - Architecture decisions (always reference)
- `README.md` - User documentation

## Workflow Rules

GitHub workflow YML files must be ultra-thin.

**Workflows MUST:**
- Trigger deployment
- Pass secrets (SSH keys, AWS credentials)
- SSH to server and run CLI command
- Use `GITHUB_ACTIONS=true` and `--staging`/`--prod` flags

**Workflows MUST NOT contain:**
- Server setup logic
- Repository cloning
- Dependency installation
- Build logic
- Bash scripts longer than 5 lines

**Correct pattern:**
```yaml
ssh -i ~/.ssh/deploy_key "$USER@$HOST" \
  "GITHUB_ACTIONS=true npx factiii deploy --staging"
```

**Why:** All logic belongs in plugins, not workflows. Exception: Node.js bootstrap (chicken-and-egg).

## Code Patterns

### When generating files
```javascript
const exists = fs.existsSync(outputPath);
if (exists) {
  const existing = fs.readFileSync(outputPath, 'utf8');
  if (existing === newContent) return; // Skip if unchanged
}
fs.writeFileSync(outputPath, newContent);
```

### When writing YAML templates
Avoid template literals with `${}` - causes YAML parse errors:
```javascript
// BAD
console.log(`Value: ${variable}`)

// GOOD
console.log('Value: ' + variable)
```

### When adding critical code
Add protection comments:
```javascript
// ============================================================
// CRITICAL: [Brief description]
// ============================================================
// Why: [Purpose]
// Breaks if changed: [Impact]
// ============================================================
```

## Common Mistakes to Avoid

- Running `npx factiii` in this repo instead of an app repo
- Adding SSH calls inside scan/fix functions (pipeline handles this)
- Running workflows without `GITHUB_ACTIONS=true --staging`/`--prod`
- Putting server setup logic in workflow YML files
- Forgetting `EXAMPLE-` prefix on required factiii.yml values
- Deleting comments without understanding their purpose

## When User Asks To...

| Request | Action |
|---------|--------|
| Test a change | Link package to app repo, test there |
| Edit app repo files | Explain what to change, don't edit directly |
| Commit changes | Ask for confirmation first |
| Add new plugin | Extend base class from `src/plugins/interfaces/` |
| Debug workflow | Check for `GITHUB_ACTIONS=true` and stage flag |

## Reference Documents
- [STANDARDS.md](STANDARDS.md) - Architecture patterns and conventions
- [README.md](README.md) - User-facing documentation
