# @factiii/stack CLI - AI Rules

## Hard Rules
- NEVER run `npx stack` in this repo (test in app repos via `pnpm link`)
- NEVER `git add/commit/push` without user approval
- NEVER delete/modify existing code comments without asking
- ALWAYS check STANDARDS.md before modifying plugin/workflow/architecture code
- WARN on standards violations before proceeding

## Standards (from STANDARDS.md)
1. **Thin workflows** - Only: trigger + secrets + SSH + CLI. No setup/clone/install/build/bash>5 lines. Exception: Node.js bootstrap.
2. **Local-only scan/fix** - NO SSH in fix functions. NO `GITHUB_ACTIONS` checks in fix functions. Pipeline routes via `canReach()`.
3. **Plugin structure** - 1000+ line plugins split into index.ts, scanfix/, environment files.
4. **Fix format** - {id, stage, severity, description, scan fn, fix fn|null, manualFix string}. Optional: `os` field for OS-specific fixes.
5. **Config values** - Required: `EXAMPLE-` prefix. Auto-detected: `OVERRIDE` pattern.
6. **Generated files** - Include `# Generated by @factiii/stack vX.X.X`.
7. **Dumb commands** - scan.ts/fix.ts/deploy.ts know nothing about GITHUB_TOKEN/SSH/workflows.
8. **Server plugins** - Define OS commands, NOT deployment targets.

## Tech Stack
Node.js + TypeScript, pnpm, Commander.js, YAML config (stack.yml/stackAuto.yml/stack.local.yml; legacy factiii.yml supported), Docker, GitHub Actions, AWS ECR, Ansible Vault, SSH direct deployment

## Architecture

**Plugin categories:** PIPELINES (factiii, aws) | SERVERS (mac, ubuntu, windows, amazon-linux) | FRAMEWORKS (expo, prisma-trpc) | ADDONS (server-mode, openclaw)

**Stages:** `--dev`, `--secrets`, `--staging`, `--prod` → pipeline returns `via:'local'`, `via:'ssh'`, `via:'workflow'`, or `reachable:false`

**Routing priority (canReach):**
1. `dev` / `secrets` → always `local`
2. `staging` / `prod` → check SSH key first (`~/.ssh/{stage}_deploy_key`) → fall back to GITHUB_TOKEN/workflow → `reachable: false`
3. AWS environments → `local` (provisioning runs from dev machine)

**Config files:**
| File | Purpose | Editable By |
|------|---------|-------------|
| `stack.yml` | Manual settings (shared) | User |
| `stackAuto.yml` | Auto-detected settings | Stack CLI (user can OVERRIDE) |
| `stack.local.yml` | Per-developer settings (gitignored) | User |

**Commands:**
| Command | Behavior |
|---------|----------|
| `npx stack` | Self-bootstrap + scan (default) |
| `npx stack init` | First-time vault/secrets setup |
| `npx stack scan [--stage]` | Read-only issue detection |
| `npx stack fix [--stage]` | Auto-fix detected issues |
| `npx stack deploy --<stage>` | Scan then deploy |
| `npx stack deploy --secrets <action>` | Manage Ansible Vault secrets |
| `npx stack db <cmd> --<stage>` | Database operations (migrate, seed, reset, status) |
| `npx stack ops <cmd> --<stage>` | Server operations (logs, restart, shell, status) |
| `npx stack backup <cmd> --<stage>` | Database backup/restore |

## Structure
```
src/
├── cli/                    # Command implementations (scan.ts, fix.ts, deploy.ts, secrets.ts, etc.)
├── generators/             # generate-compose.ts, generate-nginx.ts, generate-stack-auto.ts
├── plugins/
│   ├── pipelines/
│   │   ├── factiii/        # Main pipeline (includes AWS scanfixes)
│   │   │   ├── index.ts    # canReach(), fixes[], commands[], deployStage()
│   │   │   ├── scanfix/    # bootstrap.ts, workflows.ts, secrets.ts, etc.
│   │   │   └── workflows/  # GitHub Actions CICD templates
│   │   └── aws/            # AWS infrastructure provisioning
│   │       ├── scanfix/    # aws-cli.ts, ec2.ts, rds.ts, vpc.ts, ssh-bridge.ts, etc.
│   │       └── utils/      # aws-helpers.ts
│   ├── servers/            # OS-specific plugins (mac/, ubuntu/, windows/, amazon-linux/)
│   ├── frameworks/         # App framework plugins (prisma-trpc/, expo/)
│   ├── addons/             # Extension plugins
│   │   ├── server-mode/    # Server hardening (sleep, SSH, firewall)
│   │   └── openclaw/       # OpenClaw AI agent (Tart VM + Ollama + OpenClaw)
│   ├── interfaces/         # Base classes
│   └── approved.json       # Approved external plugins
├── utils/                  # Shared utilities (ssh-helper.ts, ansible-vault-secrets.ts, config-helpers.ts)
├── types/                  # TypeScript type definitions
└── constants/              # Config file paths, reserved keys
```
Entry: `bin/stack` | Docs: STANDARDS.md, README.md

## Key Files
- `src/plugins/pipelines/factiii/index.ts` - canReach(), deployStage(), fixes[], commands[]
- `src/utils/ssh-helper.ts` - sshExec(), findSshKeyForStage(), sshRemoteFactiiiCommand()
- `src/utils/ansible-vault-secrets.ts` - Vault encryption/decryption
- `src/utils/config-helpers.ts` - extractEnvironments(), loadLocalConfig(), LocalConfig interface
- `src/cli/scan.ts` - Two-phase bootstrap: detect missing config → run bootstrap fixes → re-scan
- `src/plugins/pipelines/factiii/scanfix/bootstrap.ts` - Self-bootstrap scanfixes
- `src/utils/generate-stack-yml.ts` - Auto-detects name, github_repo, frameworks

## Code Patterns
- **File generation:** Check exists → compare content → skip if unchanged → write
- **YAML templates:** Use string concat (`'Value: ' + var`), NOT template literals (breaks YAML)
- **Critical code:** Add `// CRITICAL:` block with Why + Breaks-if-changed
- **Config environments:** Top-level keys in stack.yml, filtered by `extractEnvironments()` (excludes RESERVED_CONFIG_KEYS)
- **SSH key convention:** `~/.ssh/{stage}_deploy_key` — stored in Ansible Vault as `{STAGE}_SSH`
- **OS filtering:** Fixes can specify `os: 'mac' as ServerOS` to run only on specific OS

## Workflow Pattern (must be ultra-thin)
```yaml
ssh -i ~/.ssh/deploy_key "$USER@$HOST" \
  "GITHUB_ACTIONS=true npx stack deploy --staging"
```
No server setup, cloning, dependency install, build logic, or bash >5 lines in workflows.

## Task Routing
| Request | Action |
|---------|--------|
| Test a change | Link to app repo, test there |
| Edit app files | Explain changes, don't edit directly |
| Commit | Ask confirmation first |
| New plugin | Follow addon pattern (server-mode/openclaw as reference) |
| New scanfix | Follow fix format: {id, stage, severity, description, scan, fix, manualFix} |
| Debug workflow | Check `GITHUB_ACTIONS=true` + stage flag |
| Debug SSH | Check `findSshKeyForStage()` + `~/.ssh/{stage}_deploy_key` |
