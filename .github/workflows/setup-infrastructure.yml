name: Setup Infrastructure

# This workflow requires a GitHub Environment variable named INFRASTRUCTURE_CONFIG
# Setup: Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí Variables ‚Üí New variable
# Name: INFRASTRUCTURE_CONFIG
# Value: Paste the entire contents of infrastructure-config.yml

on:
  workflow_dispatch:
    inputs:
      server_filter:
        description: 'Server to setup (leave empty for all servers)'
        required: false
        type: string

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout infrastructure repo
        uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Load infrastructure config from GitHub Environment
        id: config
        run: |
          # Read from GitHub Environment variable
          if [ -n "${{ vars.INFRASTRUCTURE_CONFIG }}" ]; then
            echo "${{ vars.INFRASTRUCTURE_CONFIG }}" > infrastructure-config.yml
            echo "‚úÖ Loaded config from GitHub Environment variable (INFRASTRUCTURE_CONFIG)"
          else
            echo "‚ùå Error: INFRASTRUCTURE_CONFIG not found in GitHub Environment variables" >&2
            echo "" >&2
            echo "üìã Setup Instructions:" >&2
            echo "1. Go to: Settings ‚Üí Environments ‚Üí (create or select environment)" >&2
            echo "2. Add a variable named: INFRASTRUCTURE_CONFIG" >&2
            echo "3. Paste the contents of infrastructure-config.yml as the value" >&2
            echo "4. Or use: Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí Variables" >&2
            echo "   (Variables are available to all workflows)" >&2
            exit 1
          fi

      - name: Parse config and determine required secrets
        id: parse_config
        run: |
          source ./scripts/parse-infrastructure-config.sh
          
          echo "üìã Infrastructure Configuration:"
          echo "Base Domain: $(get_base_domain)"
          echo "SSL Email: $(get_ssl_email)"
          
          echo ""
          echo "Servers and repos:"
          yq eval '.servers | to_entries | .[] | "\(.key): \(.value.repos | length) repos"' infrastructure-config.yml
          
          # Collect all unique repo/env combinations
          echo ""
          echo "üì¶ Determining required secrets..."
          
          # Get all servers
          SERVERS=$(yq eval '.servers | keys | .[]' infrastructure-config.yml)
          
          # Collect SSH keys needed
          SSH_KEYS=""
          for server in $SERVERS; do
            SSH_SECRET=$(get_ssh_secret "$server")
            if [ -n "$SSH_SECRET" ]; then
              SSH_KEYS="${SSH_KEYS}${SSH_SECRET} "
            fi
          done
          echo "SSH_KEYS=${SSH_KEYS}" >> $GITHUB_OUTPUT
          
          # Collect env var secrets needed
          ENV_SECRETS=""
          for server in $SERVERS; do
            REPOS=$(yq eval ".servers.$server.repos[] | \"\(.name)|\(.environment)\"" infrastructure-config.yml)
            while IFS='|' read -r repo_name repo_env; do
              [ -z "$repo_name" ] && continue
              ENV_SECRET_NAME="$(echo $repo_name | tr '[:lower:]' '[:upper:]' | tr '-' '_')_$(echo $repo_env | tr '[:lower:]' '[:upper:]')_ENVS"
              # Only add if not already in list
              if ! echo "$ENV_SECRETS" | grep -q "$ENV_SECRET_NAME"; then
                ENV_SECRETS="${ENV_SECRETS}${ENV_SECRET_NAME} "
              fi
            done <<< "$REPOS"
          done
          echo "ENV_SECRETS=${ENV_SECRETS}" >> $GITHUB_OUTPUT
          
          echo "Required SSH keys: ${SSH_KEYS}"
          echo "Required env secrets: ${ENV_SECRETS}"

      - name: Setup each server
        env:
          # Pass all potential SSH keys (add new ones as needed)
          MAC_MINI_SSH: ${{ secrets.MAC_MINI_SSH }}
          EC2_SSH: ${{ secrets.EC2_SSH }}
          SERVER2_SSH: ${{ secrets.SERVER2_SSH }}
          # Pass all potential env vars (add new repo/env combinations as needed)
          FACTIII_STAGING_ENVS: ${{ secrets.FACTIII_STAGING_ENVS }}
          FACTIII_PROD_ENVS: ${{ secrets.FACTIII_PROD_ENVS }}
          CHOPSHOP_STAGING_ENVS: ${{ secrets.CHOPSHOP_STAGING_ENVS }}
          CHOPSHOP_PROD_ENVS: ${{ secrets.CHOPSHOP_PROD_ENVS }}
          LINK3D_STAGING_ENVS: ${{ secrets.LINK3D_STAGING_ENVS }}
          LINK3D_PROD_ENVS: ${{ secrets.LINK3D_PROD_ENVS }}
          TAPTRACK_STAGING_ENVS: ${{ secrets.TAPTRACK_STAGING_ENVS }}
          TAPTRACK_PROD_ENVS: ${{ secrets.TAPTRACK_PROD_ENVS }}

      - name: Setup each server
        run: |
          source ./scripts/parse-infrastructure-config.sh
          
          SERVER_FILTER="${{ github.event.inputs.server_filter }}"
          
          # Get list of servers
          if [ -n "$SERVER_FILTER" ]; then
            SERVERS="$SERVER_FILTER"
          else
            SERVERS=$(yq eval '.servers | keys | .[]' infrastructure-config.yml)
          fi
          
          for server in $SERVERS; do
            echo ""
            echo "========================================"
            echo "üîß Setting up $server..."
            echo "========================================"
            
            SSH_SECRET_NAME=$(get_ssh_secret "$server")
            SSH_HOST=$(get_ssh_host "$server")
            SSH_USER=$(get_ssh_user "$server")
            
            echo "üì° Connecting to $SSH_USER@$SSH_HOST using key from $SSH_SECRET_NAME..."
            
            # Get SSH key dynamically using indirect variable expansion
            # Secrets are passed as environment variables, so we can access them via ${!VAR_NAME}
            SSH_KEY="${!SSH_SECRET_NAME}"
            
            if [ -z "$SSH_KEY" ]; then
              echo "‚ùå Error: SSH key $SSH_SECRET_NAME not found"
              echo "   Make sure:"
              echo "   1. The secret exists: Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí Secrets"
              echo "   2. The secret name matches what's in infrastructure-config.yml"
              echo "   3. Add it to the 'env:' section of the 'Setup each server' step if it's new"
              continue
            fi
            
            # Setup SSH key
            mkdir -p ~/.ssh
            echo "$SSH_KEY" > ~/.ssh/deploy_key
            chmod 600 ~/.ssh/deploy_key
            
            # Get repos for this server
            REPOS=$(yq eval ".servers.$server.repos[] | \"\(.name)|\(.environment)\"" infrastructure-config.yml)
            
            # Get repo owner for git URLs
            REPO_OWNER="${{ github.repository_owner }}"
            
            # Deploy via SSH - initial setup
            ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" bash -s << 'SETUP_EOF'
              set -e
              
              echo "üì¶ Installing dependencies..."
              
              # Check for Docker
              if ! command -v docker &> /dev/null; then
                echo "‚ö†Ô∏è Docker not found. Please install Docker first."
              else
                echo "‚úÖ Docker found"
              fi
              
              # Check for Docker Compose
              if ! command -v docker-compose &> /dev/null; then
                echo "‚ö†Ô∏è Docker Compose not found. Please install Docker Compose first."
              else
                echo "‚úÖ Docker Compose found"
              fi
              
              # Find or create infrastructure directory
              INFRA_DIR=""
              for dir in ~/infrastructure /opt/infrastructure /var/infrastructure; do
                if [ -d "$dir" ]; then
                  INFRA_DIR="$dir"
                  break
                fi
              done
              
              if [ -z "$INFRA_DIR" ]; then
                INFRA_DIR=~/infrastructure
                echo "Creating infrastructure directory at $INFRA_DIR"
                mkdir -p "$INFRA_DIR"
              fi
              
              cd "$INFRA_DIR"
              
              # Clone or update infrastructure repo
              if [ -d ".git" ]; then
                echo "üì• Pulling latest infrastructure..."
                git pull origin main || true
              else
                echo "üì• Cloning infrastructure repo..."
                cd ..
                rm -rf "$INFRA_DIR"
                git clone https://github.com/REPO_OWNER/infrastructure.git "$INFRA_DIR" || echo "‚ö†Ô∏è Could not clone infrastructure repo"
                cd "$INFRA_DIR"
              fi
              
              # Create directories
              mkdir -p repos secrets
              
              echo "‚úÖ Infrastructure directory ready at $INFRA_DIR"
            SETUP_EOF
            
            # Now setup each repo for this server
            while IFS='|' read -r repo_name repo_env; do
              [ -z "$repo_name" ] && continue
              
              echo "  üì¶ Setting up $repo_name ($repo_env)..."
              
              # Get env var secret name (format: REPO_NAME_ENV_ENVS)
              ENV_SECRET_NAME="$(echo $repo_name | tr '[:lower:]' '[:upper:]' | tr '-' '_')_$(echo $repo_env | tr '[:lower:]' '[:upper:]')_ENVS"
              
              # Access secret dynamically using indirect variable expansion
              # Secrets are passed as environment variables in the step's env: section
              ENV_CONTENT="${!ENV_SECRET_NAME}"
              
              if [ -z "$ENV_CONTENT" ]; then
                echo "‚ùå Error: Environment secret $ENV_SECRET_NAME not found"
                echo "   Make sure:"
                echo "   1. The secret exists: Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí Secrets"
                echo "   2. Format: <REPO_NAME>_<ENV>_ENVS (e.g., MYREPO_STAGING_ENVS)"
                echo "   3. Add it to the 'env:' section of the 'Setup each server' step if it's new"
                continue
              fi
              
              REPO_GIT_URL="https://github.com/$REPO_OWNER/${repo_name}.git"
              
              ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" bash -s << EOF
                set -e
                
                INFRA_DIR=""
                for dir in ~/infrastructure /opt/infrastructure /var/infrastructure; do
                  if [ -d "\$dir" ]; then
                    INFRA_DIR="\$dir"
                    break
                  fi
                done
                
                cd "\$INFRA_DIR"
                
                # Clone repo if not exists
                if [ ! -d "repos/$repo_name" ]; then
                  echo "    üì• Cloning $repo_name..."
                  git clone "$REPO_GIT_URL" "repos/$repo_name" || echo "    ‚ö†Ô∏è Could not clone $repo_name"
                else
                  echo "    üì• Updating $repo_name..."
                  cd "repos/$repo_name"
                  git pull origin main || git pull origin master || true
                  cd ../..
                fi
                
                # Write env file
                mkdir -p secrets
                printf '%s\n' "$ENV_CONTENT" > "secrets/${repo_name}-${repo_env}.env"
                
                echo "    ‚úÖ $repo_name ($repo_env) ready"
              EOF
            done <<< "$REPOS"
            
            # Run final setup commands
            ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" bash -s << 'FINAL_EOF'
              set -e
              
              INFRA_DIR=""
              for dir in ~/infrastructure /opt/infrastructure /var/infrastructure; do
                if [ -d "$dir" ]; then
                  INFRA_DIR="$dir"
                  break
                fi
              done
              
              cd "$INFRA_DIR"
              
              # Generate nginx config if script exists
              if [ -f "./scripts/generate-nginx-config.sh" ]; then
                echo "üìù Generating nginx config..."
                chmod +x ./scripts/generate-nginx-config.sh
                ./scripts/generate-nginx-config.sh || echo "‚ö†Ô∏è Could not generate nginx config (yq may not be installed)"
              fi
              
              # Start services
              echo "üê≥ Starting Docker services..."
              docker-compose up -d || echo "‚ö†Ô∏è Docker Compose failed - check configuration"
              
              echo "‚úÖ Setup complete for this server!"
            FINAL_EOF
            
            # Cleanup SSH key
            rm -f ~/.ssh/deploy_key
            
            echo "‚úÖ Server $server setup complete"
          done
          
          echo ""
          echo "========================================"
          echo "‚úÖ All servers setup complete!"
          echo "========================================"
