name: Setup Infrastructure

# ============================================================================
# AUTO-GENERATED FILE - DO NOT EDIT DIRECTLY
# ============================================================================
# This file is generated from setup-infrastructure.yml.template
# To update, modify infrastructure-config.yml then run:
#   node scripts/generate-workflow.js
# ============================================================================

on:
  workflow_dispatch:
    inputs:
      server_filter:
        description: 'Server name to setup (leave empty for all servers)'
        required: false
        type: string

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout infrastructure repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Load infrastructure config
        run: |
          if [ -n "${{ vars.INFRASTRUCTURE_CONFIG }}" ]; then
            echo "${{ vars.INFRASTRUCTURE_CONFIG }}" > infrastructure-config.yml
            echo "âœ… Loaded config from GitHub variable"
          else
            echo "âŒ INFRASTRUCTURE_CONFIG not found"
            exit 1
          fi

      - name: Display configuration
        run: |
          source ./scripts/parse-infrastructure-config.sh
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“‹ INFRASTRUCTURE CONFIGURATION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "SSL Email: $(get_ssl_email)"
          echo ""
          SERVERS=$(yq eval '.servers | keys | .[]' infrastructure-config.yml)
          for server in $SERVERS; do
            echo "ğŸ–¥ï¸ $server: $(get_ssh_user $server)@$(get_ssh_host $server)"
            yq eval ".servers.$server.repos[] | \"   - \" + .name + \" (\" + .environment + \") â†’ \" + .domain" infrastructure-config.yml
          done
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Generate docker-compose.yml and nginx.conf
        env:
          AWS_SECRETS: ${{ secrets.AWS_SECRETS }}
        run: |
          export ECR_REGISTRY=$(echo "$AWS_SECRETS" | jq -r '.ECR_REGISTRY')
          export ECR_REPOSITORY=$(echo "$AWS_SECRETS" | jq -r '.ECR_REPOSITORY')
          node scripts/generate-all.js

      - name: Setup servers
        env:
          AWS_SECRETS: ${{ secrets.AWS_SECRETS }}
{{SECRETS_ENV_BLOCK}}
        run: |
          source ./scripts/parse-infrastructure-config.sh
          
          SERVER_FILTER="${{ github.event.inputs.server_filter }}"
          if [ -n "$SERVER_FILTER" ]; then
            SERVERS="$SERVER_FILTER"
          else
            SERVERS=$(yq eval '.servers | keys | .[]' infrastructure-config.yml)
          fi
          
          AWS_ACCESS_KEY_ID=$(echo "$AWS_SECRETS" | jq -r '.AWS_ACCESS_KEY_ID')
          AWS_SECRET_ACCESS_KEY=$(echo "$AWS_SECRETS" | jq -r '.AWS_SECRET_ACCESS_KEY')
          AWS_REGION=$(echo "$AWS_SECRETS" | jq -r '.AWS_REGION')
          ECR_REGISTRY=$(echo "$AWS_SECRETS" | jq -r '.ECR_REGISTRY')
          
          for server in $SERVERS; do
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸ”§ Setting up: $server"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            
            SSH_SECRET_NAME=$(get_ssh_secret "$server")
            SSH_HOST=$(get_ssh_host "$server")
            SSH_USER=$(get_ssh_user "$server")
            SSH_KEY="${!SSH_SECRET_NAME}"
            
            if [ -z "$SSH_KEY" ]; then
              echo "âŒ SSH key '$SSH_SECRET_NAME' not found"
              continue
            fi
            
            mkdir -p ~/.ssh
            echo "$SSH_KEY" > ~/.ssh/deploy_key
            chmod 600 ~/.ssh/deploy_key
            
            echo "ğŸ“¡ Connecting to $SSH_USER@$SSH_HOST..."
            
            # Create temp directory on server and copy files
            ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" "mkdir -p ~/infrastructure-files"
            scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no docker-compose.yml "$SSH_USER@$SSH_HOST:~/infrastructure-files/"
            scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no nginx/nginx.conf "$SSH_USER@$SSH_HOST:~/infrastructure-files/"
            
            # Run setup script on server
            ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" 'bash -s' << 'REMOTE_SETUP'
          set -e
          echo "ğŸ“¦ Checking dependencies..."
          command -v docker &> /dev/null && echo "âœ… Docker found" || { echo "âŒ Docker not found"; exit 1; }
          
          INFRA_DIR=""
          for dir in ~/infrastructure /opt/infrastructure /var/infrastructure; do
            [ -d "$dir" ] && INFRA_DIR="$dir" && break
          done
          [ -z "$INFRA_DIR" ] && INFRA_DIR=~/infrastructure && mkdir -p "$INFRA_DIR"
          
          cd "$INFRA_DIR"
          mkdir -p nginx secrets repos
          mv ~/infrastructure-files/docker-compose.yml . 2>/dev/null || true
          mv ~/infrastructure-files/nginx.conf nginx/ 2>/dev/null || true
          rmdir ~/infrastructure-files 2>/dev/null || true
          echo "âœ… Infrastructure directory ready: $INFRA_DIR"
          REMOTE_SETUP
            
            # Write secrets for each service
            REPOS=$(yq eval ".servers.$server.repos[] | \"\(.name)|\(.environment)\"" infrastructure-config.yml)
            while IFS='|' read -r repo_name repo_env; do
              [ -z "$repo_name" ] && continue
              SERVICE_NAME="${repo_name}-${repo_env}"
              ENV_SECRET_NAME="$(echo $repo_name | tr '[:lower:]' '[:upper:]' | tr '-' '_')_$(echo $repo_env | tr '[:lower:]' '[:upper:]')_ENVS"
              ENV_CONTENT="${!ENV_SECRET_NAME}"
              
              if [ -z "$ENV_CONTENT" ]; then
                echo "âš ï¸ Missing secret: $ENV_SECRET_NAME"
                continue
              fi
              
              echo "ğŸ“ Writing secrets for $SERVICE_NAME..."
              echo "$ENV_CONTENT" | ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" "cat > ~/infrastructure/secrets/${SERVICE_NAME}.env"
            done <<< "$REPOS"
            
            # Start services
            ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" "bash -s" << REMOTE_START
          set -e
          cd ~/infrastructure 2>/dev/null || cd /opt/infrastructure 2>/dev/null || cd /var/infrastructure
          echo "ğŸ” Logging into ECR..."
          aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY
          echo "ğŸ³ Starting services..."
          docker compose pull
          docker compose up -d
          echo "ğŸ“Š Service status:"
          docker compose ps
          REMOTE_START
            
            rm -f ~/.ssh/deploy_key
            echo "âœ… Server $server setup complete"
          done
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Infrastructure setup complete!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
