name: Add Repo to Infrastructure

on:
  workflow_dispatch:
    inputs:
      repo_name:
        description: 'Repository name'
        required: true
        type: string
      git_url:
        description: 'Git URL'
        required: true
        type: string
      server_name:
        description: 'Server name'
        required: true
        type: string
      environment:
        description: 'Environment'
        required: true
        type: choice
        options:
          - staging
          - prod
      domain_override:
        description: 'Domain override (optional, leave empty for default)'
        required: false
        type: string
      port:
        description: 'Port number (default: 5001)'
        required: false
        type: string
        default: '5001'

jobs:
  add-repo:
    runs-on: ubuntu-latest
    env:
      MAC_MINI_SSH: ${{ secrets.MAC_MINI_SSH }}
      EC2_SSH: ${{ secrets.EC2_SSH }}
      SERVER2_SSH: ${{ secrets.SERVER2_SSH }}
    steps:
      - name: Checkout infrastructure repo
        uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Validate server exists
        run: |
          source ./scripts/parse-infrastructure-config.sh
          
          SERVER="${{ github.event.inputs.server_name }}"
          SSH_SECRET=$(get_ssh_secret "$SERVER" 2>/dev/null || echo "")
          
          if [ -z "$SSH_SECRET" ]; then
            echo "Error: Server $SERVER not found in infrastructure-config.yml" >&2
            echo "Available servers:"
            yq eval '.servers | keys | .[]' infrastructure-config.yml
            exit 1
          fi
          
          echo "‚úÖ Server $SERVER found"

      - name: Add repo to config
        run: |
          REPO_NAME="${{ github.event.inputs.repo_name }}"
          SERVER="${{ github.event.inputs.server_name }}"
          ENV="${{ github.event.inputs.environment }}"
          DOMAIN_OVERRIDE="${{ github.event.inputs.domain_override }}"
          
          # Check if repo already exists for this server/environment
          EXISTING=$(yq eval ".servers.$SERVER.repos[] | select(.name == \"$REPO_NAME\" and .environment == \"$ENV\")" infrastructure-config.yml)
          
          if [ -n "$EXISTING" ]; then
            echo "‚ö†Ô∏è Repo $REPO_NAME ($ENV) already exists on $SERVER"
            exit 0
          fi
          
          # Add repo to config using yq
          if [ -n "$DOMAIN_OVERRIDE" ]; then
            yq eval ".servers.$SERVER.repos += [{\"name\": \"$REPO_NAME\", \"environment\": \"$ENV\", \"domain_override\": \"$DOMAIN_OVERRIDE\"}]" -i infrastructure-config.yml
          else
            yq eval ".servers.$SERVER.repos += [{\"name\": \"$REPO_NAME\", \"environment\": \"$ENV\", \"domain_override\": null}]" -i infrastructure-config.yml
          fi
          
          echo "‚úÖ Added $REPO_NAME to $SERVER ($ENV)"
          
          echo ""
          echo "Updated config:"
          yq eval ".servers.$SERVER.repos" infrastructure-config.yml

      - name: Commit config changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add infrastructure-config.yml
          git commit -m "Add ${{ github.event.inputs.repo_name }} to ${{ github.event.inputs.server_name }} (${{ github.event.inputs.environment }})" || echo "No changes to commit"
          git push || echo "Push failed or no changes"

      - name: Setup repo on server
        run: |
          source ./scripts/parse-infrastructure-config.sh
          
          SERVER="${{ github.event.inputs.server_name }}"
          REPO_NAME="${{ github.event.inputs.repo_name }}"
          GIT_URL="${{ github.event.inputs.git_url }}"
          ENV="${{ github.event.inputs.environment }}"
          PORT="${{ github.event.inputs.port }}"
          
          SSH_SECRET_NAME=$(get_ssh_secret "$SERVER")
          SSH_HOST=$(get_ssh_host "$SERVER")
          SSH_USER=$(get_ssh_user "$SERVER")
          
          echo "üì° Connecting to $SSH_USER@$SSH_HOST..."
          
          # Get the SSH key from environment variable
          SSH_KEY="${!SSH_SECRET_NAME}"
          
          if [ -z "$SSH_KEY" ]; then
            echo "‚ùå Error: SSH key $SSH_SECRET_NAME not found in secrets"
            echo "Please add the SSH key as a secret and re-run"
            exit 1
          fi
          
          # Setup SSH key
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Clone repo and setup on server
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" bash -s << EOF
            set -e
            
            # Find infrastructure directory
            INFRA_DIR=""
            for dir in ~/infrastructure /opt/infrastructure /var/infrastructure; do
              if [ -d "\$dir" ]; then
                INFRA_DIR="\$dir"
                break
              fi
            done
            
            if [ -z "\$INFRA_DIR" ]; then
              echo "Error: Infrastructure directory not found"
              exit 1
            fi
            
            cd "\$INFRA_DIR"
            
            # Pull latest infrastructure
            git pull origin main || true
            
            # Clone repo if not exists
            if [ ! -d "repos/$REPO_NAME" ]; then
              echo "üì• Cloning $REPO_NAME..."
              mkdir -p repos
              git clone "$GIT_URL" "repos/$REPO_NAME"
            else
              echo "üì• Repo already exists, updating..."
              cd "repos/$REPO_NAME"
              git pull origin main || git pull origin master || true
              cd ../..
            fi
            
            # Create env file template
            mkdir -p secrets
            if [ ! -f "secrets/${REPO_NAME}-${ENV}.env" ]; then
              printf '# Environment variables for %s (%s)\n# Add your environment variables here\nNODE_ENV=\${ENV}\nPORT=\$PORT\n# DATABASE_URL=\n# Add other variables as needed\n' "$REPO_NAME" "$ENV" > "secrets/${REPO_NAME}-${ENV}.env"
              echo "üìù Created template: secrets/${REPO_NAME}-${ENV}.env"
              echo "‚ö†Ô∏è Please add the environment variables to GitHub Secrets:"
              echo "   Secret name: $(echo $REPO_NAME | tr '[:lower:]' '[:upper:]' | tr '-' '_')_$(echo $ENV | tr '[:lower:]' '[:upper:]')_ENVS"
            fi
            
            # Regenerate nginx config
            if [ -f "./scripts/generate-nginx-config.sh" ] && command -v yq &> /dev/null; then
              echo "üìù Regenerating nginx config..."
              ./scripts/generate-nginx-config.sh
            fi
            
            echo "‚úÖ Repo $REPO_NAME added successfully"
            echo ""
            echo "Next steps:"
            echo "1. Add environment variables to GitHub Secrets"
            echo "2. Add service to docker-compose.yml"
            echo "3. Run deployment workflow"
          EOF
          
          # Cleanup SSH key
          rm -f ~/.ssh/deploy_key
          
          echo ""
          echo "‚úÖ Repo added to $SERVER"
          echo ""
          echo "üìã Manual steps required:"
          echo "1. Add the following service to docker-compose.yml:"
          echo ""
          echo "  ${REPO_NAME}-${ENV}:"
          echo "    build:"
          echo "      context: ./repos/${REPO_NAME}"
          echo "      dockerfile: apps/server/Dockerfile"
          echo "    container_name: ${REPO_NAME}-${ENV}"
          echo "    environment:"
          echo "      - NODE_ENV=${ENV}"
          echo "    env_file:"
          echo "      - ./secrets/${REPO_NAME}-${ENV}.env"
          echo "    networks:"
          echo "      - infrastructure_network"
          echo "    restart: unless-stopped"
          echo "    healthcheck:"
          echo "      test: [\"CMD\", \"curl\", \"-f\", \"http://localhost:${PORT}/health\"]"
          echo "      interval: 30s"
          echo "      timeout: 10s"
          echo "      retries: 3"
          echo "      start_period: 40s"
          echo ""
          echo "2. Add environment variables secret to GitHub:"
          echo "   Name: $(echo $REPO_NAME | tr '[:lower:]' '[:upper:]' | tr '-' '_')_$(echo $ENV | tr '[:lower:]' '[:upper:]')_ENVS"
