name: Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      deploy_scope:
        description: 'What to deploy'
        required: true
        type: choice
        options:
          - all
          - specific-repo
          - specific-server
      repo_name:
        description: 'Repo name (if specific-repo selected)'
        required: false
        type: string
      server_name:
        description: 'Server name (if specific-server selected)'
        required: false
        type: string
      environment:
        description: 'Environment (staging/prod)'
        required: false
        type: choice
        options:
          - staging
          - prod
          - both

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      # Pass all potential SSH keys - workflow will use the correct one per server
      MAC_MINI_SSH: ${{ secrets.MAC_MINI_SSH }}
      EC2_SSH: ${{ secrets.EC2_SSH }}
      SERVER2_SSH: ${{ secrets.SERVER2_SSH }}
      # Pass all potential env vars
      FACTIII_STAGING_ENVS: ${{ secrets.FACTIII_STAGING_ENVS }}
      FACTIII_PROD_ENVS: ${{ secrets.FACTIII_PROD_ENVS }}
      CHOPSHOP_STAGING_ENVS: ${{ secrets.CHOPSHOP_STAGING_ENVS }}
      CHOPSHOP_PROD_ENVS: ${{ secrets.CHOPSHOP_PROD_ENVS }}
      LINK3D_STAGING_ENVS: ${{ secrets.LINK3D_STAGING_ENVS }}
      LINK3D_PROD_ENVS: ${{ secrets.LINK3D_PROD_ENVS }}
      TAPTRACK_STAGING_ENVS: ${{ secrets.TAPTRACK_STAGING_ENVS }}
      TAPTRACK_PROD_ENVS: ${{ secrets.TAPTRACK_PROD_ENVS }}
    steps:
      - name: Checkout infrastructure repo
        uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Determine deployment targets
        id: targets
        run: |
          source ./scripts/parse-infrastructure-config.sh
          
          DEPLOY_SCOPE="${{ github.event.inputs.deploy_scope }}"
          REPO_NAME="${{ github.event.inputs.repo_name }}"
          SERVER_NAME="${{ github.event.inputs.server_name }}"
          ENV_FILTER="${{ github.event.inputs.environment }}"
          
          echo "Deploy scope: $DEPLOY_SCOPE"
          
          # Build deployment list
          touch /tmp/deployments.txt
          
          if [ "$DEPLOY_SCOPE" = "all" ]; then
            # Deploy all repos on all servers
            yq eval '.servers | to_entries | .[] | .key as $server | .value.repos[] | "\($server)|\(.name)|\(.environment)"' infrastructure-config.yml > /tmp/deployments.txt
          elif [ "$DEPLOY_SCOPE" = "specific-repo" ]; then
            # Deploy specific repo on all servers it's configured for
            if [ -z "$REPO_NAME" ]; then
              echo "Error: repo_name required for specific-repo scope" >&2
              exit 1
            fi
            ENVS="staging prod"
            if [ "$ENV_FILTER" != "both" ] && [ -n "$ENV_FILTER" ]; then
              ENVS="$ENV_FILTER"
            fi
            for env in $ENVS; do
              yq eval ".servers | to_entries | .[] | select(.value.repos[] | .name == \"$REPO_NAME\" and .environment == \"$env\") | \"\(.key)|$REPO_NAME|$env\"" infrastructure-config.yml >> /tmp/deployments.txt
            done
          elif [ "$DEPLOY_SCOPE" = "specific-server" ]; then
            # Deploy all repos on specific server
            if [ -z "$SERVER_NAME" ]; then
              echo "Error: server_name required for specific-server scope" >&2
              exit 1
            fi
            yq eval ".servers.$SERVER_NAME.repos[] | \"$SERVER_NAME|\(.name)|\(.environment)\"" infrastructure-config.yml >> /tmp/deployments.txt
          fi
          
          # Filter by environment if specified and not "both"
          if [ "$ENV_FILTER" != "both" ] && [ -n "$ENV_FILTER" ] && [ "$DEPLOY_SCOPE" != "specific-repo" ]; then
            grep "|$ENV_FILTER$" /tmp/deployments.txt > /tmp/deployments_filtered.txt || true
            mv /tmp/deployments_filtered.txt /tmp/deployments.txt
          fi
          
          echo "Deployment targets:"
          cat /tmp/deployments.txt

      - name: Deploy to servers
        run: |
          source ./scripts/parse-infrastructure-config.sh
          
          while IFS='|' read -r server repo env; do
            [ -z "$server" ] && continue
            
            echo ""
            echo "========================================"
            echo "ðŸš€ Deploying $repo ($env) to $server..."
            echo "========================================"
            
            SSH_SECRET_NAME=$(get_ssh_secret "$server")
            SSH_HOST=$(get_ssh_host "$server")
            SSH_USER=$(get_ssh_user "$server")
            
            echo "ðŸ“¡ Connecting to $SSH_USER@$SSH_HOST using key from $SSH_SECRET_NAME..."
            
            # Get the SSH key from environment variable (secret name from config)
            SSH_KEY="${!SSH_SECRET_NAME}"
            
            if [ -z "$SSH_KEY" ]; then
              echo "âŒ Error: SSH key $SSH_SECRET_NAME not found in secrets"
              continue
            fi
            
            # Setup SSH key
            mkdir -p ~/.ssh
            echo "$SSH_KEY" > ~/.ssh/deploy_key
            chmod 600 ~/.ssh/deploy_key
            
            # Get env var secret name
            ENV_SECRET_NAME="$(echo $repo | tr '[:lower:]' '[:upper:]' | tr '-' '_')_$(echo $env | tr '[:lower:]' '[:upper:]')_ENVS"
            ENV_CONTENT="${!ENV_SECRET_NAME}"
            
            # Get repo git URL (assumes GitHub, adjust as needed)
            REPO_GIT_URL="https://github.com/${{ github.repository_owner }}/${repo}.git"
            
            # Deploy via SSH
            ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" bash -s << EOF
              set -e
              
              # Find infrastructure directory
              INFRA_DIR=""
              for dir in ~/infrastructure /opt/infrastructure /var/infrastructure; do
                if [ -d "\$dir" ]; then
                  INFRA_DIR="\$dir"
                  break
                fi
              done
              
              if [ -z "\$INFRA_DIR" ]; then
                echo "Error: Infrastructure directory not found"
                exit 1
              fi
              
              cd "\$INFRA_DIR"
              
              # Pull latest infrastructure
              git pull origin main || true
              
              # Clone or pull repo
              if [ -d "repos/$repo" ]; then
                cd repos/$repo
                git fetch origin
                git checkout main || git checkout master
                git pull origin main || git pull origin master
                cd ../..
              else
                echo "Cloning $repo..."
                mkdir -p repos
                git clone "$REPO_GIT_URL" "repos/$repo" || echo "Warning: Could not clone $repo"
              fi
              
              # Write env file
              mkdir -p secrets
              printf '%s\n' "$ENV_CONTENT" > "secrets/${repo}-${env}.env"
              
              # Build and deploy container
              SERVICE_NAME="${repo}-${env}"
              echo "Building and deploying \$SERVICE_NAME..."
              docker-compose build \$SERVICE_NAME || true
              docker-compose up -d \$SERVICE_NAME
              
              echo "âœ… Deployed \$SERVICE_NAME"
            EOF
            
            # Cleanup SSH key
            rm -f ~/.ssh/deploy_key
            
          done < /tmp/deployments.txt
          
          echo ""
          echo "========================================"
          echo "âœ… Deployment complete!"
          echo "========================================"
