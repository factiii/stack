const fs = require('fs');
const path = require('path');
const yaml = require('js-yaml');

/**
 * Get Factiii package version
 */
function getFactiiiVersion() {
  try {
    const packageJsonPath = path.join(__dirname, '../../package.json');
    const pkg = JSON.parse(fs.readFileSync(packageJsonPath, 'utf8'));
    return pkg.version || '1.0.0';
  } catch (e) {
    return '1.0.0';
  }
}

/**
 * Load all plugins
 */
function loadAllPlugins() {
  const plugins = [];
  
  // Load pipeline plugins
  try {
    const FactiiiPipeline = require('../plugins/pipelines/factiii');
    plugins.push(FactiiiPipeline);
  } catch (e) {
    // Plugin not available
  }
  
  // Load server plugins
  try {
    const MacMiniPlugin = require('../plugins/servers/mac-mini');
    plugins.push(MacMiniPlugin);
  } catch (e) {
    // Plugin not available
  }
  
  try {
    const AWSPlugin = require('../plugins/servers/aws');
    plugins.push(AWSPlugin);
  } catch (e) {
    // Plugin not available
  }
  
  // Load framework plugins
  try {
    const PrismaTrpcPlugin = require('../plugins/frameworks/prisma-trpc');
    plugins.push(PrismaTrpcPlugin);
  } catch (e) {
    // Plugin not available
  }
  
  return plugins;
}

/**
 * Generate factiiiAuto.yml with auto-detected values from plugins
 */
async function generateFactiiiAuto(rootDir, options = {}) {
  const outputPath = path.join(rootDir, 'factiiiAuto.yml');
  
  console.log('üîç Auto-detecting project configuration...\n');
  
  // Use provided plugins or load all
  const plugins = options.plugins || loadAllPlugins();
  const autoConfig = {
    factiii_version: getFactiiiVersion(),
    factiii_min_version: getFactiiiVersion()
  };
  
  // Collect auto-detected config from each plugin
  for (const PluginClass of plugins) {
    if (PluginClass.detectConfig) {
      try {
        const detected = await PluginClass.detectConfig(rootDir);
        if (detected) {
          Object.assign(autoConfig, detected);
          
          // Log what was detected
          if (PluginClass.id === 'prisma-trpc' && detected.has_prisma) {
            console.log(`   ‚úÖ Prisma detected`);
            if (detected.prisma_schema) console.log(`      Schema: ${detected.prisma_schema}`);
            if (detected.prisma_version) console.log(`      Version: ${detected.prisma_version}`);
          }
          if (PluginClass.id === 'prisma-trpc' && detected.has_trpc) {
            console.log(`   ‚úÖ tRPC detected`);
          }
          if (PluginClass.id === 'factiii' && detected.dockerfile) {
            console.log(`   ‚úÖ Dockerfile: ${detected.dockerfile}`);
          }
          if (PluginClass.id === 'factiii' && detected.package_manager) {
            console.log(`   üì¶ Package manager: ${detected.package_manager}`);
          }
          if (PluginClass.id === 'factiii' && detected.node_version) {
            console.log(`   üì¶ Node version: ${detected.node_version}`);
          }
          if (PluginClass.id === 'factiii' && detected.pnpm_version) {
            console.log(`   üì¶ pnpm version: ${detected.pnpm_version}`);
          }
          if (PluginClass.id === 'aws' && detected.aws_cli_installed) {
            console.log(`   ‚úÖ AWS CLI installed`);
          }
        }
      } catch (e) {
        console.log(`   ‚ö†Ô∏è  Error detecting ${PluginClass.id}: ${e.message}`);
      }
    }
  }
  
  // Convert to YAML with comments
  const content = yaml.dump(autoConfig, {
    lineWidth: -1,
    noRefs: true
  });
  
  // Add header comments
  const header = [
    '# Auto-detected configuration',
    '# Generated by: npx factiii',
    '# To override values, add: value OVERRIDE newvalue',
    ''
  ].join('\n');
  
  const finalContent = header + content;
  
  // Check if file exists and content changed
  const exists = fs.existsSync(outputPath);
  if (exists) {
    const existingContent = fs.readFileSync(outputPath, 'utf8');
    if (existingContent === finalContent) {
      console.log('\n‚è≠Ô∏è  factiiiAuto.yml unchanged');
      return;
    }
  }
  
  // Write file
  fs.writeFileSync(outputPath, finalContent);
  
  if (exists) {
    console.log('\nüîÑ Updated factiiiAuto.yml');
  } else {
    console.log('\n‚úÖ Created factiiiAuto.yml');
  }
}

module.exports = { generateFactiiiAuto };
