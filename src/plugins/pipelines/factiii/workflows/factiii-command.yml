name: Factiii Command

# Generated by @factiii/stack v{VERSION}
# INFRASTRUCTURE: Run plugin commands on remote servers
# Run: npx factiii db seed --staging (triggers this workflow)

on:
  workflow_dispatch:
    inputs:
      category:
        description: 'Command category (db, ops, backup)'
        required: true
        type: string
      command:
        description: 'Command to run (e.g., seed, migrate, logs)'
        required: true
        type: string
      stage:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - prod
      options:
        description: 'Command options (JSON)'
        required: false
        default: '{}'

jobs:
  run-command:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Read config
        id: config
        env:
          STAGE: ${{ inputs.stage }}
        run: |
          if [ ! -f "factiii.yml" ]; then
            echo "factiii.yml not found"
            exit 1
          fi

          REPO_NAME=$(yq eval '.name' factiii.yml)
          HOST=$(yq eval ".$STAGE.domain // \"\"" factiii.yml)
          SSH_USER=$(yq eval ".$STAGE.ssh_user // \"ubuntu\"" factiii.yml)

          echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT
          echo "host=$HOST" >> $GITHUB_OUTPUT
          echo "ssh_user=$SSH_USER" >> $GITHUB_OUTPUT

      - name: Check environment configured
        env:
          STAGE: ${{ inputs.stage }}
        run: |
          HAS_ENV=$(yq eval ".$STAGE != null" factiii.yml)
          if [ "$HAS_ENV" != "true" ]; then
            echo "$STAGE environment not configured in factiii.yml"
            exit 1
          fi

      - name: Check SSH secret
        env:
          STAGE: ${{ inputs.stage }}
          SSH_KEY: ${{ inputs.stage == 'staging' && secrets.STAGING_SSH || secrets.PROD_SSH }}
        run: |
          if [ -z "$SSH_KEY" ]; then
            SECRET_NAME="${STAGE^^}_SSH"
            echo "${SECRET_NAME} secret not found"
            echo "Add it at: https://github.com/${{ github.repository }}/settings/secrets/actions"
            exit 1
          fi

      - name: Setup SSH
        env:
          SSH_KEY: ${{ inputs.stage == 'staging' && secrets.STAGING_SSH || secrets.PROD_SSH }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

      - name: Run command via SSH
        env:
          HOST: ${{ steps.config.outputs.host }}
          USER: ${{ steps.config.outputs.ssh_user }}
          REPO_NAME: ${{ steps.config.outputs.repo_name }}
          CATEGORY: ${{ inputs.category }}
          COMMAND: ${{ inputs.command }}
          STAGE: ${{ inputs.stage }}
        run: |
          if [ -z "$HOST" ]; then
            echo "Missing domain in factiii.yml: $STAGE.domain"
            exit 1
          fi

          echo "Running: factiii $CATEGORY $COMMAND --$STAGE"
          echo "Server: $USER@$HOST"
          echo ""

          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=10 -o ServerAliveInterval=60 -o ServerAliveCountMax=5 "$USER@$HOST" \
            "export PATH=\"/opt/homebrew/bin:/usr/local/bin:\$PATH\" && \
             REPO_DIR=\"\$HOME/.factiii/$REPO_NAME\" && \
             if [ -d \"\$REPO_DIR\" ]; then \
               cd \"\$REPO_DIR\" && \
               GITHUB_ACTIONS=true npx factiii $CATEGORY $COMMAND --$STAGE; \
             else \
               echo \"Repo directory not found at \$REPO_DIR\"; \
               echo \"Run deployment first to clone the repository\"; \
               exit 1; \
             fi"

          EXIT_CODE=$?
          rm -f ~/.ssh/deploy_key

          if [ $EXIT_CODE -eq 0 ]; then
            echo ""
            echo "Command completed successfully"
          else
            echo ""
            echo "Command failed with exit code $EXIT_CODE"
            exit $EXIT_CODE
          fi
