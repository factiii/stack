name: Core Undeploy

# Completely removes this repository from staging and production servers.
# Deletes all configs, environment files, containers, and data.
# This action cannot be undone.

on:
  workflow_dispatch:
    inputs:
      repo_name:
        description: 'Repository name to remove (defaults to current repo)'
        required: false
        type: string
      environment:
        description: 'Environment to remove from (staging/prod/all)'
        required: true
        default: 'all'
        type: choice
        options:
          - staging
          - prod
          - all

env:
  NODE_VERSION: '20'

jobs:
  undeploy-staging:
    if: |
      github.event.inputs.environment == 'staging' || 
      github.event.inputs.environment == 'all'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Remove from staging server
        env:
          SSH_KEY: ${{ secrets.STAGING_SSH }}
          SSH_HOST: ${{ secrets.STAGING_HOST }}
          SSH_USER: ${{ secrets.STAGING_USER || 'ubuntu' }}
          REPO_NAME: ${{ github.event.inputs.repo_name || github.event.repository.name }}
        run: |
          if [ -z "$SSH_KEY" ] || [ -z "$SSH_HOST" ]; then
            echo "âŒ Missing SSH credentials for staging"
            exit 1
          fi
          
          echo "$SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          SERVICE_KEY="${REPO_NAME}-staging"
          
          echo "ðŸ›‘ Stopping and removing containers..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            "$SSH_USER@$SSH_HOST" \
            "cd ~/infrastructure && \
             docker compose stop ${SERVICE_KEY} 2>/dev/null || true && \
             docker compose rm -f ${SERVICE_KEY} 2>/dev/null || true"
          
          echo "ðŸ“ Removing config file..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            "$SSH_USER@$SSH_HOST" \
            "rm -f ~/infrastructure/configs/${REPO_NAME}.yml"
          
          echo "ðŸ” Removing environment file..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            "$SSH_USER@$SSH_HOST" \
            "rm -f ~/infrastructure/${REPO_NAME}-staging.env"
          
          echo "ðŸ”„ Regenerating configurations..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            "$SSH_USER@$SSH_HOST" \
            "cd ~/infrastructure && \
             INFRA_DIR=~/infrastructure ~/infrastructure/scripts/check-config.sh 2>/dev/null || true"
          
          rm -f ~/.ssh/deploy_key
          echo "âœ… Removed ${REPO_NAME} from staging"

  undeploy-prod:
    if: |
      github.event.inputs.environment == 'prod' || 
      github.event.inputs.environment == 'all'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Remove from production server
        env:
          SSH_KEY: ${{ secrets.PROD_SSH }}
          SSH_HOST: ${{ secrets.PROD_HOST }}
          SSH_USER: ${{ secrets.PROD_USER || 'ubuntu' }}
          REPO_NAME: ${{ github.event.inputs.repo_name || github.event.repository.name }}
        run: |
          if [ -z "$SSH_KEY" ] || [ -z "$SSH_HOST" ]; then
            echo "âŒ Missing SSH credentials for production"
            exit 1
          fi
          
          echo "$SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          SERVICE_KEY="${REPO_NAME}-prod"
          
          echo "ðŸ›‘ Stopping and removing containers..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            "$SSH_USER@$SSH_HOST" \
            "cd ~/infrastructure && \
             docker compose stop ${SERVICE_KEY} 2>/dev/null || true && \
             docker compose rm -f ${SERVICE_KEY} 2>/dev/null || true"
          
          echo "ðŸ“ Removing config file..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            "$SSH_USER@$SSH_HOST" \
            "rm -f ~/infrastructure/configs/${REPO_NAME}.yml"
          
          echo "ðŸ” Removing environment file..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            "$SSH_USER@$SSH_HOST" \
            "rm -f ~/infrastructure/${REPO_NAME}-prod.env"
          
          echo "ðŸ”„ Regenerating configurations..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            "$SSH_USER@$SSH_HOST" \
            "cd ~/infrastructure && \
             INFRA_DIR=~/infrastructure ~/infrastructure/scripts/check-config.sh 2>/dev/null || true"
          
          rm -f ~/.ssh/deploy_key
          echo "âœ… Removed ${REPO_NAME} from production"

  trigger-deploy:
    needs: [undeploy-staging, undeploy-prod]
    if: always() && (needs.undeploy-staging.result != 'failure' && needs.undeploy-prod.result != 'failure')
    runs-on: ubuntu-latest
    steps:
      - name: Trigger deploy workflow
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'core-deploy.yml',
              ref: context.ref,
              inputs: {
                environment: 'all'
              }
            });
            console.log('âœ… Triggered deploy workflow to regenerate configurations');
