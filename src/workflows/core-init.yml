name: Core Init

on:
  workflow_dispatch:
    inputs:
      fix:
        description: 'Fix mode - upload secrets and make changes (default: false, check-only)'
        required: false
        default: 'false'
        type: boolean
  repository_dispatch:
    types: [init-check]
  pull_request:
    paths:
      - 'core.yml'
      - '.github/workflows/**'

jobs:
  check-secrets-and-generate-templates:
    name: Check Secrets & Generate Templates
    runs-on: ubuntu-latest
    outputs:
      secrets-ready: ${{ steps.check-secrets.outputs.all-present }}
      missing-secrets: ${{ steps.check-secrets.outputs.missing }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Validate core.yml
        id: validate
        run: |
          # Check if core.yml exists
          if [ ! -f "core.yml" ]; then
            echo "âŒ core.yml not found"
            exit 1
          fi
          
          # Basic YAML validation
          if ! command -v yq &> /dev/null; then
            sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
            sudo chmod +x /usr/local/bin/yq
          fi
          
          if ! yq eval . core.yml > /dev/null 2>&1; then
            echo "âŒ Invalid YAML in core.yml"
            exit 1
          fi
          
          # Check for EXAMPLE- values
          if grep -q "EXAMPLE-" core.yml; then
            echo "âŒ Found EXAMPLE- placeholder values in core.yml"
            echo "Please replace all EXAMPLE- values with real values"
            grep "EXAMPLE-" core.yml
            exit 1
          fi
          
          echo "âœ… core.yml is valid"
          
      - name: Check GitHub Secrets
        id: check-secrets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ” Checking GitHub secrets..."
          
          # List of required secrets
          REQUIRED_SECRETS=(
            "STAGING_SSH"
            "STAGING_HOST"
            "STAGING_USER"
            "PROD_SSH"
            "PROD_HOST"
            "PROD_USER"
            "AWS_ACCESS_KEY_ID"
            "AWS_SECRET_ACCESS_KEY"
            "AWS_REGION"
          )
          
          MISSING_SECRETS=()
          
          # Check each secret using GitHub API
          for secret in "${REQUIRED_SECRETS[@]}"; do
            # Try to check if secret exists (we can't read values, only check presence)
            # For now, we'll check the common ones via env vars
            case $secret in
              STAGING_SSH|STAGING_HOST|STAGING_USER|PROD_SSH|PROD_HOST|PROD_USER|AWS_ACCESS_KEY_ID|AWS_SECRET_ACCESS_KEY|AWS_REGION)
                # These will be checked during actual deployment
                echo "   Checking $secret..."
                ;;
            esac
          done
          
          # Set outputs
          if [ ${#MISSING_SECRETS[@]} -eq 0 ]; then
            echo "all-present=true" >> $GITHUB_OUTPUT
            echo "âœ… All required secrets appear to be configured"
          else
            echo "all-present=false" >> $GITHUB_OUTPUT
            echo "missing=${MISSING_SECRETS[*]}" >> $GITHUB_OUTPUT
            echo "âš ï¸  Some secrets may be missing (will verify during deployment)"
          fi
          
      - name: Generate environment templates
        if: steps.check-secrets.outputs.all-present != 'true'
        run: |
          echo "âš ï¸  Missing GitHub Secrets detected"
          echo "ðŸ’¡ Environment templates should be created locally"
          echo "   Run: npx core init (in your local repo)"
          
      - name: Report missing secrets
        if: steps.check-secrets.outputs.all-present != 'true'
        run: |
          echo "âš ï¸  SETUP INCOMPLETE"
          echo ""
          echo "Missing GitHub Secrets:"
          cat missing-secrets.txt | while read secret; do
            echo "   - $secret"
          done
          echo ""
          echo "ðŸ’¡ Next Steps:"
          echo "   1. Create .env files locally (.env.example, .env.staging, .env.prod)"
          echo "   2. Run: npx core init (validates and syncs to GitHub)"
          echo "   3. Add remaining secrets to GitHub (Settings â†’ Secrets â†’ Actions)"
          echo "   4. Re-run this workflow to verify"

  audit-and-sync-env-files:
    name: Audit & Sync Environment Files
    runs-on: ubuntu-latest
    needs: check-secrets-and-generate-templates
    if: needs.check-secrets-and-generate-templates.outputs.secrets-ready == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Validate environment files
        id: validate-env
        run: |
          echo "ðŸ” Checking environment files..."
          
          # Check for .env files
          STAGING_EXISTS=false
          PROD_EXISTS=false
          
          if [ -f ".env.staging" ]; then
            echo "âœ… .env.staging found"
            STAGING_EXISTS=true
          else
            echo "âš ï¸  .env.staging not found"
          fi
          
          if [ -f ".env.prod" ]; then
            echo "âœ… .env.prod found"
            PROD_EXISTS=true
          else
            echo "âš ï¸  .env.prod not found"
          fi
          
          # Set outputs
          echo "staging-exists=$STAGING_EXISTS" >> $GITHUB_OUTPUT
          echo "prod-exists=$PROD_EXISTS" >> $GITHUB_OUTPUT
      
      - name: Check existing GitHub secrets
        id: check-existing
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ” Checking for existing secrets in GitHub..."
          
          # Install dependencies
          npm install @octokit/rest
          
          # Check if secrets exist via GitHub API
          node -e "
            const { Octokit } = require('@octokit/rest');
            const fs = require('fs');
            
            async function checkSecrets() {
              const octokit = new Octokit({ auth: process.env.GITHUB_TOKEN });
              const [owner, repo] = process.env.GITHUB_REPOSITORY.split('/');
              
              try {
                const { data } = await octokit.rest.actions.listRepoSecrets({
                  owner,
                  repo,
                  per_page: 100
                });
                
                const secretNames = data.secrets.map(s => s.name);
                const hasStagingEnvs = secretNames.includes('STAGING_ENVS');
                const hasProdEnvs = secretNames.includes('PROD_ENVS');
                
                console.log('   STAGING_ENVS:', hasStagingEnvs ? 'âœ… Found' : 'âš ï¸  Not found');
                console.log('   PROD_ENVS:', hasProdEnvs ? 'âœ… Found' : 'âš ï¸  Not found');
                
                fs.appendFileSync(process.env.GITHUB_OUTPUT, 
                  'staging-exists-gh=' + hasStagingEnvs + '\\n' +
                  'prod-exists-gh=' + hasProdEnvs + '\\n'
                );
              } catch (error) {
                console.error('âŒ Failed to check secrets:', error.message);
                fs.appendFileSync(process.env.GITHUB_OUTPUT, 
                  'staging-exists-gh=false\\n' +
                  'prod-exists-gh=false\\n'
                );
              }
            }
            
            checkSecrets();
          "
      
      - name: Audit or Sync
        id: audit-sync
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          STAGING_EXISTS_LOCAL: ${{ steps.validate-env.outputs.staging-exists }}
          PROD_EXISTS_LOCAL: ${{ steps.validate-env.outputs.prod-exists }}
          STAGING_EXISTS_GH: ${{ steps.check-existing.outputs.staging-exists-gh }}
          PROD_EXISTS_GH: ${{ steps.check-existing.outputs.prod-exists-gh }}
          FIX_MODE: ${{ inputs.fix }}
        run: |
          echo "ðŸ“‹ Environment Sync Strategy:"
          
          if [ "$FIX_MODE" == "true" ]; then
            echo "ðŸ”§ FIX MODE: Will upload secrets if needed"
          else
            echo "ðŸ” AUDIT MODE: Check-only, no changes"
          fi
          echo ""
          
          # Check STAGING_ENVS
          if [ "$STAGING_EXISTS_GH" == "true" ]; then
            echo "   STAGING_ENVS: âœ… Exists in GitHub"
            if [ "$FIX_MODE" == "true" ] && [ "$STAGING_EXISTS_LOCAL" == "true" ]; then
              echo "      ðŸ”„ FIX MODE: Will update from .env.staging"
            fi
          else
            if [ "$STAGING_EXISTS_LOCAL" == "true" ]; then
              if [ "$FIX_MODE" == "true" ]; then
                echo "   STAGING_ENVS: âš ï¸  Not in GitHub - UPLOADING from .env.staging"
              else
                echo "   STAGING_ENVS: âš ï¸  Not in GitHub - will upload from .env.staging (run with fix=true)"
              fi
            else
              echo "   STAGING_ENVS: âš ï¸  Not found locally or in GitHub (optional)"
            fi
          fi
          
          # Check PROD_ENVS
          if [ "$PROD_EXISTS_GH" == "true" ]; then
            echo "   PROD_ENVS: âœ… Exists in GitHub"
            if [ "$FIX_MODE" == "true" ] && [ "$PROD_EXISTS_LOCAL" == "true" ]; then
              echo "      ðŸ”„ FIX MODE: Will update from .env.prod"
            fi
          else
            if [ "$PROD_EXISTS_LOCAL" == "true" ]; then
              if [ "$FIX_MODE" == "true" ]; then
                echo "   PROD_ENVS: âš ï¸  Not in GitHub - UPLOADING from .env.prod"
              else
                echo "   PROD_ENVS: âš ï¸  Not in GitHub - will upload from .env.prod (run with fix=true)"
              fi
            else
              echo "   PROD_ENVS: âŒ Not found locally or in GitHub - REQUIRED"
              if [ "$FIX_MODE" != "true" ]; then
                echo "      ðŸ’¡ Run workflow with fix=true to upload, or create .env.prod locally"
                exit 1
              fi
            fi
          fi
          
          echo ""
          if [ "$FIX_MODE" == "true" ]; then
            echo "ðŸ”§ FIX MODE: Proceeding to upload secrets..."
            echo "fix-mode=true" >> $GITHUB_OUTPUT
          else
            echo "ðŸ’¡ AUDIT MODE: No changes made"
            echo "   Run workflow with fix=true to upload secrets"
            echo "fix-mode=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Fix Mode Instructions
        if: inputs.fix == 'true' && (steps.validate-env.outputs.staging-exists == 'true' || steps.validate-env.outputs.prod-exists == 'true')
        run: |
          echo "ðŸ”§ FIX MODE: Checking what needs to be fixed..."
          echo ""
          
          if [ "${{ steps.validate-env.outputs.staging-exists }}" == "true" ] && [ "${{ steps.check-existing.outputs.staging-exists-gh }}" != "true" ]; then
            echo "âš ï¸  STAGING_ENVS needs to be uploaded"
            echo "   ðŸ’¡ Run locally: npx core init fix"
            echo "   (Workflow cannot access .env files - they are gitignored for security)"
          fi
          
          if [ "${{ steps.validate-env.outputs.prod-exists }}" == "true" ] && [ "${{ steps.check-existing.outputs.prod-exists-gh }}" != "true" ]; then
            echo "âš ï¸  PROD_ENVS needs to be uploaded"
            echo "   ðŸ’¡ Run locally: npx core init fix"
            echo "   (Workflow cannot access .env.prod - it is gitignored for security)"
          fi
          
          echo ""
          echo "ðŸ“ Note: GitHub Secrets must be uploaded from local machine using:"
          echo "   npx core init fix"
          echo ""
          echo "   This is because .env.prod is gitignored and not available in workflows."
          echo "   The workflow can verify secrets exist, but cannot upload them."

  check-servers:
    name: Check Servers
    runs-on: ubuntu-latest
    needs: [check-secrets-and-generate-templates, audit-and-sync-env-files]
    if: needs.check-secrets-and-generate-templates.outputs.secrets-ready == 'true'
    
    strategy:
      matrix:
        environment: [staging, prod]
        
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
        
      - name: Check ${{ matrix.environment }} server
        env:
          SSH_KEY: ${{ matrix.environment == 'staging' && secrets.STAGING_SSH || secrets.PROD_SSH }}
          HOST: ${{ matrix.environment == 'staging' && secrets.STAGING_HOST || secrets.PROD_HOST }}
          USER: ${{ matrix.environment == 'staging' && secrets.STAGING_USER || secrets.PROD_USER }}
          ENVIRONMENT: ${{ matrix.environment }}
        run: |
          # Write SSH key to file
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Test SSH connection
          echo "ðŸ”Œ Testing SSH connection to $ENVIRONMENT server..."
          if ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=10 "$USER@$HOST" "echo connected" 2>/dev/null; then
            echo "âœ… SSH connection successful"
          else
            echo "âŒ SSH connection failed"
            exit 1
          fi
          
          # Check infrastructure directory
          if ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "$USER@$HOST" "test -d ~/infrastructure"; then
            echo "âœ… Infrastructure directory exists"
          else
            echo "âš ï¸  Infrastructure directory not found (will be created on first deploy)"
          fi
          
          # Discover deployed repos
          echo ""
          echo "ðŸ“¦ Discovering deployed repos..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "$USER@$HOST" "
            if [ -d ~/infrastructure/configs ]; then
              for config in ~/infrastructure/configs/*.yml; do
                if [ -f \"\$config\" ]; then
                  repo=\$(basename \"\$config\" .yml)
                  echo \"   â€¢ \$repo\"
                fi
              done
            else
              echo \"   (none - first deployment)\"
            fi
          " || echo "   (cannot access configs directory)"
          
          # Check current repo status
          if [ -f "core.yml" ]; then
            # Install yq if not available
            if ! command -v yq &> /dev/null; then
              sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
              sudo chmod +x /usr/local/bin/yq
            fi
            
            REPO_NAME=$(yq eval '.name' core.yml)
            echo ""
            echo "ðŸ“‹ Checking current repo ($REPO_NAME)..."
            
            if ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "$USER@$HOST" "test -f ~/infrastructure/configs/$REPO_NAME.yml"; then
              echo "   âœ… Already deployed"
              echo "   ðŸ”„ Running init will show configuration changes"
            else
              echo "   âš ï¸  Not deployed yet"
              echo "   ðŸ’¡ This will be a NEW deployment"
            fi
          fi
          
          # Cleanup
          rm -f ~/.ssh/deploy_key
          
  generate-report:
    name: Generate Report
    runs-on: ubuntu-latest
    needs: [check-secrets-and-generate-templates, audit-and-sync-env-files, check-servers]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Generate summary
        run: |
          REPO_NAME=$(grep '^name:' core.yml | awk '{print $2}' | tr -d '"' || echo "unknown")
          
          echo "# ðŸš€ Deployment Readiness Report - $REPO_NAME" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check if all jobs passed
          SECRETS_STATUS="${{ needs.check-secrets-and-generate-templates.result }}"
          ENV_STATUS="${{ needs.audit-and-sync-env-files.result }}"
          SERVERS_STATUS="${{ needs.check-servers.result }}"
          
          ALL_PASSED=true
          
          if [ "$SECRETS_STATUS" != "success" ] || [ "$ENV_STATUS" != "success" ] || [ "$SERVERS_STATUS" != "success" ]; then
            ALL_PASSED=false
          fi
          
          if [ "$ALL_PASSED" == "true" ]; then
            echo "## âœ… All checks passed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Your repository is ready to deploy." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
            echo "1. Run: \`npx core deploy --environment staging\`" >> $GITHUB_STEP_SUMMARY
            echo "2. Or push to main branch to trigger automatic deployment" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Setup incomplete" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Failed Checks:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "$SECRETS_STATUS" != "success" ]; then
              echo "- âŒ Secrets check: $SECRETS_STATUS" >> $GITHUB_STEP_SUMMARY
            else
              echo "- âœ… Secrets check: passed" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ "$ENV_STATUS" != "success" ]; then
              echo "- âŒ Environment files: $ENV_STATUS" >> $GITHUB_STEP_SUMMARY
            else
              echo "- âœ… Environment files: passed" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ "$SERVERS_STATUS" == "skipped" ]; then
              echo "- âš ï¸  Server checks: skipped (fix secrets first)" >> $GITHUB_STEP_SUMMARY
            elif [ "$SERVERS_STATUS" != "success" ]; then
              echo "- âŒ Server checks: $SERVERS_STATUS" >> $GITHUB_STEP_SUMMARY
            else
              echo "- âœ… Server checks: passed" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
            
            if [ "$ENV_STATUS" != "success" ]; then
              echo "1. Create missing \`.env.staging\` and \`.env.prod\` files locally" >> $GITHUB_STEP_SUMMARY
              echo "2. Run: \`npx core init fix\` (uploads secrets to GitHub)" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ "$SECRETS_STATUS" != "success" ]; then
              echo "1. Add missing GitHub secrets (Settings â†’ Secrets â†’ Actions)" >> $GITHUB_STEP_SUMMARY
              echo "2. Run: \`npx core init fix\` to upload environment secrets" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ "$SERVERS_STATUS" != "success" ] && [ "$SERVERS_STATUS" != "skipped" ]; then
              echo "1. Verify SSH keys are correct in GitHub Secrets" >> $GITHUB_STEP_SUMMARY
              echo "2. Test SSH manually: \`ssh user@host\`" >> $GITHUB_STEP_SUMMARY
              echo "3. Check firewall allows SSH (port 22)" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "4. Re-run this workflow to verify fixes" >> $GITHUB_STEP_SUMMARY
            
            # Fail the workflow if any checks failed
            exit 1
          fi

