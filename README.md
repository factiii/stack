# Core Infrastructure Package

An npm package that auto-scans your T3 stack (Next.js, Expo, tRPC, Prisma), detects configuration, and handles deployment to staging and production servers.

## Philosophy

**Single approach:** Auto-scanning with adapters.

Core scans your repository structure, identifies installed packages, and automatically configures deployment. Manual configuration is only required for settings that cannot be auto-detected (domains, credentials, etc.).

## Quick Start

### 1. Install

```bash
npm install @factiii/core
# or use directly with npx
```

### 2. Initialize

```bash
npx core init
```

This will:
- Scan your project structure
- Detect Next.js, Expo, tRPC, Prisma
- Generate `coreAuto.yml` with detected settings
- Create `core.yml` template for manual settings
- Set up `.env` templates

### 3. Configure

Edit `core.yml` and replace all `EXAMPLE-` values:

```yaml
name: my-app                    # Your repo name
github_repo: myorg/my-app       # GitHub repository
ssl_email: admin@example.com    # SSL certificate email
staging_domain: staging.example.com
prod_domain: app.example.com
```

### 4. Fix All Environments

```bash
npx core init fix
```

This prepares staging and production servers for deployment.

### 5. Deploy

```bash
npx core deploy
```

---

## Configuration

### Two Configuration Files

| File | Purpose | Managed By |
|------|---------|------------|
| `core.yml` | Manual settings (domains, credentials) | You |
| `coreAuto.yml` | Auto-detected settings | Core |

### core.yml (Manual Settings)

Settings that **cannot** be auto-detected use the `EXAMPLE-` prefix:

```yaml
# Repository name
name: EXAMPLE-factiii

# SSL email for Let's Encrypt
ssl_email: EXAMPLE-admin@yourdomain.com

# Domains
staging_domain: EXAMPLE-staging.yourdomain.com
prod_domain: EXAMPLE-app.yourdomain.com
```

**Core blocks deployment if any `EXAMPLE-` values remain.**

### coreAuto.yml (Auto-Detected Settings)

Generated by `npx core init`. Contains detected stack configuration:

```yaml
has_nextjs: true
has_expo: true
has_trpc: true
has_prisma: true
prisma_schema: apps/server/prisma/schema.prisma
dockerfile: apps/server/Dockerfile
package_manager: pnpm
```

**Override Pattern:**

To override an auto-detected value:

```yaml
dockerfile: apps/server/Dockerfile OVERRIDE custom/Dockerfile
```

Core warns when auto-detected values change unexpectedly (drift detection).

---

## Environment Files

| File | Required | Git Status | Purpose |
|------|----------|------------|---------|
| `.env.dev` | Yes | Committed | Development defaults |
| `.env.staging` | Optional | Configurable | Staging values |
| `.env.prod` | Yes | **Gitignored** | Production secrets |
| `.env.test` | Optional | Committed | Test values |

Core generates `.env.dev` as a template based on detected adapters.

---

## Commands

### `npx core init`

Validate configuration and auto-fix local dev environment.

**Local (dev):**
- Detects stack (Next.js, Expo, tRPC, Prisma)
- Generates `coreAuto.yml`
- Validates `core.yml`
- Installs missing dependencies
- Creates missing config files
- **Can modify files** (developers can git revert)

**Remote (staging/prod):**
- SSH to servers (read-only)
- Validates deployed configurations
- Reports mismatches
- **No modifications**

### `npx core init fix`

Explicitly fix ALL environments including remote servers.

```bash
npx core init fix           # Fix all environments
npx core init fix --dry-run # Preview changes only
```

**What it does:**
- Everything `init` does locally
- SSH to staging/prod and:
  - Create missing directories
  - Fix file permissions
  - Generate server configs
  - Validate configurations

**What it does NOT do:**
- Deploy containers
- Restart services
- Modify application code

### `npx core deploy`

Run init check, then deploy if checks pass.

```bash
npx core deploy                    # Deploy to all
npx core deploy --environment staging
npx core deploy --environment prod
```

**Pre-deployment check:**
- Runs `init` (not `init fix`)
- Analyzes any failures

**Non-blocking (proceeds with warning):**
- Environment variable changes
- Domain updates with overrides
- Port reassignments with overrides

**Blocking (stops deployment):**
- `EXAMPLE-` values still present
- Invalid YAML syntax
- Missing critical files
- SSH connection failures
- Unexpected configuration drift

---

## GitHub Actions Workflows

### Staging (main branch)

**Trigger:** PR merged to main

```
init checks → build → test → deploy container
```

### Production (production branch)

**Trigger:** Merge to production branch

```
clean repo → pnpm install → test → build → deliver container → deploy → run migrations
```

---

## Deployment Targets

| Environment | Platform | Server |
|-------------|----------|--------|
| Staging | Mac | Development/testing |
| Production | Ubuntu | Production hosting |

**Stack:**
- nginx (reverse proxy)
- Docker containers (application)

**Multi-server support:**
- `PROD_SSH` - Primary production
- `PROD_SSH2` - Replica (optional)

---

## GitHub Secrets

Configure in **Settings → Secrets → Actions**:

**SSH Keys:**
- `STAGING_SSH` - Private key for staging
- `PROD_SSH` - Private key for production

**AWS Credentials:**
- `AWS_ACCESS_KEY_ID`
- `AWS_SECRET_ACCESS_KEY`
- `AWS_REGION`

**Environment Variables:**
- `STAGING_ENVS` - Staging env vars (newline-separated `key=value`)
- `PROD_ENVS` - Production env vars (newline-separated `key=value`)

---

## Troubleshooting

### "EXAMPLE- values found"

Edit `core.yml` and replace all `EXAMPLE-` prefixed values with actual values.

### "SSH connection failed"

1. Verify SSH key is in GitHub Secrets
2. Test manually: `ssh -i ~/.ssh/key user@host`
3. Check firewall allows port 22

### "Configuration drift detected"

Auto-detected value changed unexpectedly. Either:
1. Add an override: `setting: old OVERRIDE new`
2. Run `npx core init fix` to update deployed config

### "Deployment blocked"

Run `npx core init` to see what's blocking, then `npx core init fix` to resolve.

---

## Future: Adapters

Adapters will be extracted from core as the system matures:

| Phase | Adapter | Status |
|-------|---------|--------|
| 1 | Core only | **Current** |
| 2 | Next.js | Planned |
| 3 | Expo | Planned |
| 4 | Prisma/tRPC | Planned |

See [STANDARDS.md](STANDARDS.md) for full architecture details.

---

## Development (This Repository)

**This is the Core package itself.** Do not run `npx core` commands here.

Test changes in a separate application repository:

```bash
cd /path/to/test-app
npm link /path/to/infrastructure
npx core init
```

See [STANDARDS.md](STANDARDS.md) for development guidelines.

---

## License

MIT
