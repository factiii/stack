# Factiii Stack Infrastructure Package

An npm package that auto-scans your T3 stack (Next.js, Expo, tRPC, Prisma), detects configuration, and handles deployment to staging and production servers.

## Philosophy

**Single approach:** Auto-scanning with adapters.

Factiii scans your repository structure, identifies installed packages, and automatically configures deployment. Manual configuration is only required for settings that cannot be auto-detected (domains, credentials, etc.).

## Quick Start

### 1. Install

```bash
npm install @factiii/stack
# or use directly with npx
```

### 2. Set Up GitHub Token (One-time)

```bash
# Generate token: https://github.com/settings/tokens
# Select scopes: repo + workflow

# Add to shell config (persists across sessions)
echo 'export GITHUB_TOKEN=ghp_your_token_here' >> ~/.zshrc
source ~/.zshrc
```

### 3. Initialize (Check Everything)

```bash
npx factiii init
```

**Stage 1: Check** - Discovers all issues without making changes:
- Scans project structure (Next.js, Expo, tRPC, Prisma)
- Generates `factiiiAuto.yml` with detected settings
- Creates `factiii.yml` template for manual settings
- Checks GitHub secrets exist
- Validates SSH connections to servers
- **Reports everything that needs fixing**

### 4. Configure

Edit `factiii.yml` and replace all `EXAMPLE-` values:

```yaml
name: my-app                    # Your repo name
ssl_email: admin@example.com    # SSL certificate email
staging_domain: staging.example.com
prod_domain: app.example.com
```

Create `.env.staging` and `.env.prod` with your environment variables.

### 5. Fix All Issues (Fix Everything)

```bash
npx factiii init fix
```

**Stage 2: Fix** - Fixes everything in logical order:
1. **Local:** All configs, dependencies, scripts
2. **GitHub:** Uploads secrets from `.env` files
3. **Servers:** Sets up infrastructure via SSH
4. **Verification:** Triggers workflow to confirm all fixes

After this command, everything is ready for deployment.

### 6. Deploy

```bash
npx factiii deploy
```

---

## Configuration

### Two Configuration Files

| File | Purpose | Managed By |
|------|---------|------------|
| `factiii.yml` | Manual settings (domains, credentials) | You |
| `factiiiAuto.yml` | Auto-detected settings | Factiii |

### factiii.yml (Manual Settings)

Settings that **cannot** be auto-detected use the `EXAMPLE-` prefix:

```yaml
# Repository name
name: EXAMPLE-factiii

# SSL email for Let's Encrypt
ssl_email: EXAMPLE-admin@yourdomain.com

# Domains
staging_domain: EXAMPLE-staging.yourdomain.com
prod_domain: EXAMPLE-app.yourdomain.com
```

**Factiii blocks deployment if any `EXAMPLE-` values remain.**

### factiiiAuto.yml (Auto-Detected Settings)

Generated by `npx factiii init`. Contains detected stack configuration:

```yaml
has_nextjs: true
has_expo: true
has_trpc: true
has_prisma: true
prisma_schema: apps/server/prisma/schema.prisma
dockerfile: apps/server/Dockerfile
package_manager: pnpm
```

**Override Pattern:**

To override an auto-detected value:

```yaml
dockerfile: apps/server/Dockerfile OVERRIDE custom/Dockerfile
```

Factiii warns when auto-detected values change unexpectedly (drift detection).

---

## Environment Files

| File | Required | Git Status | Purpose |
|------|----------|------------|---------|
| `.env.dev` | Yes | Committed | Development defaults |
| `.env.staging` | Optional | Configurable | Staging values |
| `.env.prod` | Yes | **Gitignored** | Production secrets |
| `.env.test` | Optional | Committed | Test values |

Factiii generates `.env.dev` as a template based on detected adapters.

---

## Commands

### `npx factiii init`

Comprehensive check of everything - local, GitHub, and remote servers. Auto-fixes local only.

**What it checks:**
- **Local:** All files, configs, dependencies, scripts (auto-fixes these)
- **GitHub:** Secrets, workflows, repository settings (check-only)
- **Remote:** Deployed configurations on servers (check-only via SSH)

**Local (auto-fix enabled):**
- Detects stack (Next.js, Expo, tRPC, Prisma)
- Generates `factiiiAuto.yml`
- Validates `factiii.yml`
- Installs missing dependencies
- Creates missing config files
- **Can modify files** (developers can git revert)

**GitHub (check-only):**
- Verifies required secrets exist
- Checks workflow files
- Reports missing secrets
- **No modifications** - use `init fix` to upload

**Remote (staging/prod) - check-only:**
- SSH to servers (read-only)
- Validates deployed configurations
- Reports mismatches
- **No modifications** - use `init fix` for server fixes

### `npx factiii init fix`

Fix everything that `init` checks - local, GitHub, and remote servers. Prepares everything for deployment.

```bash
npx factiii init fix           # Fix all environments
npx factiii init fix --dry-run # Preview changes only
```

**What it fixes:**

**Local:**
- Everything `init` does (all local configs, dependencies, files)

**GitHub:**
- Uploads `STAGING_ENVS` from `.env.staging`
- Uploads `PROD_ENVS` from `.env.prod`
- Creates/updates GitHub Secrets as needed

**Remote servers:**
- SSH to staging/prod and:
  - Create missing directories
  - Fix file permissions
  - Generate server configs
  - Validate configurations

**What it does NOT do:**
- Deploy containers (that's what `deploy` is for)
- Update server deployment configs (nginx, docker-compose on servers)
- Restart services
- Modify application code

**After `init fix`:**
Everything is fully prepared for deployment. Run `npx factiii deploy` to actually deploy.

### `npx factiii deploy`

Deploy directly via SSH (no GitHub workflows needed).

```bash
npx factiii deploy                    # Deploy to all environments
npx factiii deploy --environment staging
npx factiii deploy --environment prod
```

**What it does:**
1. Validates config locally (checks for EXAMPLE- values, etc.)
2. Builds Docker image and pushes to ECR
3. SSHs to server and deploys via docker-compose

**Blocking (stops deployment):**
- `EXAMPLE-` values still present
- Invalid YAML syntax
- Missing SSH credentials
- SSH connection failures

---

## GitHub Actions Workflows (Generated for Repos)

**Key Distinction:** Factiii GENERATES these workflows for your repo but does NOT use them itself.

- Factiii deploys directly via SSH (`npx factiii deploy`)
- Workflows are for YOUR repo to run its own CI/CD on git events
- They run independently - Factiii doesn't trigger or depend on them

### Generated Workflows

| Workflow | Trigger | Purpose |
|----------|---------|---------|
| `factiii-staging.yml` | PR/push to main | Auto-deploy to staging |
| `factiii-production.yml` | Merge to production | Auto-deploy to production |
| `factiii-undeploy.yml` | Manual | Cleanup/remove deployment |

### Staging (main branch)

**Trigger:** PR merged to main

```
test â†’ build â†’ push to ECR â†’ deploy container
```

### Production (production branch)

**Trigger:** Merge to production branch

```
test â†’ build â†’ push to ECR â†’ backup DB â†’ deploy â†’ migrations
```

### Why Both CLI and Workflows?

- **CLI (`npx factiii deploy`)**: For manual/immediate deployments from your machine
- **Workflows**: For automated CI/CD on git events (optional but recommended)

---

## Deployment Targets

| Environment | Platform | Server |
|-------------|----------|--------|
| Staging | Mac | Development/testing |
| Production | Ubuntu | Production hosting |

**Stack:**
- nginx (reverse proxy)
- Docker containers (application)

**Multi-server support:**
- `PROD_SSH` - Primary production
- `PROD_SSH2` - Replica (optional)

---

## Managing Secrets

Factiii provides a unified CLI for managing all GitHub secrets without manually using the GitHub UI.

### First-Time Setup

```bash
npx factiii init fix
```

This command:
1. âœ… Checks GitHub for missing secrets via API
2. âœ… Reads `.env.staging` and `.env.prod` files and uploads to GitHub
3. âœ… Prompts interactively for missing infrastructure secrets (SSH keys, AWS credentials)
4. âœ… Uploads everything to GitHub via API
5. ðŸš€ Offers to deploy immediately

### Update Specific Secrets

```bash
# Update one or more secrets
npx factiii secrets STAGING_SSH PROD_SSH

# Update with inline value (for scripting)
npx factiii secrets STAGING_SSH --value "$(cat ~/.ssh/id_ed25519)"
```

The command will:
- Prompt for each secret with context and validation
- Show helpful generation instructions
- Upload to GitHub immediately
- Offer to deploy after updating

### Interactive Secret Management

```bash
npx factiii secrets
```

Interactive mode:
1. Shows status of all secrets (âœ… exists / âŒ missing)
2. Lets you select which to update
3. Prompts for each selected secret
4. Uploads all to GitHub
5. Offers to deploy

### Environment Variables vs Infrastructure Secrets

| Secret Type | Source | Update Command |
|-------------|--------|----------------|
| `STAGING_ENVS` | `.env.staging` file | Edit file â†’ `npx factiii init fix` |
| `PROD_ENVS` | `.env.prod` file | Edit file â†’ `npx factiii init fix` |
| `STAGING_SSH`, `PROD_SSH` | Prompt (never stored locally) | `npx factiii secrets STAGING_SSH` |
| `AWS_*` credentials | Prompt (never stored locally) | `npx factiii secrets AWS_ACCESS_KEY_ID` |
| `*_HOST`, `*_USER` | Prompt (never stored locally) | `npx factiii secrets STAGING_HOST` |

**Why two approaches?**
- **Application env vars** change frequently (developers add/modify config) â†’ file-based workflow
- **Infrastructure secrets** change rarely (SSH keys, AWS creds) â†’ prompt-based, never committed

### Required GitHub Secrets

Only truly sensitive values go in GitHub Secrets:

**SSH Keys:**
- `STAGING_SSH` - Private key for staging server
- `PROD_SSH` - Private key for production server

**AWS Credentials:**
- `AWS_SECRET_ACCESS_KEY` - AWS secret key (only secret AWS value)

**Environment Variables (optional):**
- `STAGING_ENVS` - From `.env.staging` file
- `PROD_ENVS` - From `.env.prod` file

**Not Secrets (in factiii.yml):**
- `environments.{env}.host` - Server hostname/IP
- `aws.access_key_id` - AWS access key ID
- `aws.region` - AWS region

**Not Secrets (in factiiiAuto.yml):**
- `ssh_user` - SSH username (defaults to ubuntu)

### Generating SSH Keys

```bash
# For staging
ssh-keygen -t ed25519 -C "staging-deploy" -f ~/.ssh/staging_deploy

# For production
ssh-keygen -t ed25519 -C "production-deploy" -f ~/.ssh/prod_deploy

# Copy public key to server
cat ~/.ssh/staging_deploy.pub | ssh user@staging-host "cat >> ~/.ssh/authorized_keys"
```

Then upload with:
```bash
npx factiii secrets STAGING_SSH
# Paste the PRIVATE key when prompted
```

---

## Troubleshooting

### "EXAMPLE- values found"

Edit `factiii.yml` and replace all `EXAMPLE-` prefixed values with actual values.

### "SSH connection failed"

1. Verify SSH key is in GitHub Secrets
2. Test manually: `ssh -i ~/.ssh/key user@host`
3. Check firewall allows port 22

### "Configuration drift detected"

Auto-detected value changed unexpectedly. Either:
1. Add an override: `setting: old OVERRIDE new`
2. Run `npx factiii init fix` to update deployed config

### "Deployment blocked"

Run `npx factiii init` to see what's blocking, then `npx factiii init fix` to resolve.

---

## Versioning & Upgrades

Factiii uses semantic versioning. Check your version:

```bash
npx factiii --version
```

### Upgrading

```bash
# Check for updates
npx factiii upgrade --check

# Upgrade to latest
npm update @factiii/stack

# Regenerate configs for new version
npx factiii upgrade
```

### Version Compatibility

Your `factiiiAuto.yml` tracks which version generated it:

```yaml
core_version: 1.0.0      # Version that generated this
core_min_version: 1.0.0  # Minimum compatible version
```

If you see version warnings, run `npx factiii upgrade` to migrate.

### Breaking Changes

Major version bumps (1.x â†’ 2.x) may require config changes.
Always check the [CHANGELOG](CHANGELOG.md) before upgrading.

---

## Roadmap

Plugins will be extracted from the base package as the system matures:

| Phase | Plugin | Status |
|-------|--------|--------|
| 1 | Factiii Stack | **Current** |
| 2 | Expo | Planned |
| 3 | Prisma/tRPC Server | Planned |
| 4 | AWS Free Tier | Planned |
| 5 | Next.js/Vercel | Planned |

See [STANDARDS.md](STANDARDS.md) for full architecture details.

---

## Development (This Repository)

**This is the Factiii Stack package itself.** Do not run `npx factiii` commands here.

Test changes in a separate application repository:

```bash
cd /path/to/test-app
npm link /path/to/infrastructure
npx factiii init
```

See [STANDARDS.md](STANDARDS.md) for development guidelines.

---

## License

MIT
